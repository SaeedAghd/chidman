{% extends 'store_analysis/base.html' %}
{% load static %}

{% block title %}درخواست تحلیل رایگان فروشگاه{% endblock %}

{% block extra_css %}
<style>
    /* طراحی کلی فرم */
    .analysis-form {
        background: white;
        padding: 2.5rem;
        border-radius: 1.5rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }

    .analysis-form:hover {
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
    }

    /* عنوان‌های بخش */
    .form-section-title {
        color: var(--primary-color);
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 2rem;
        position: relative;
        padding-bottom: 1rem;
    }

    .form-section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 60px;
        height: 4px;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        border-radius: 2px;
    }

    /* فیلدهای فرم */
    .form-label {
        font-weight: 500;
        margin-bottom: 0.75rem;
        color: #2c3e50;
        transition: all 0.3s ease;
    }

    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        transform: translateY(-1px);
    }

    /* نشانگر فیلدهای اجباری */
    .required-field::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }

    /* گروه‌های رادیویی و چک‌باکس */
    .form-check {
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .form-check:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }

    .form-check-input {
        width: 1.25rem;
        height: 1.25rem;
        margin-top: 0.25rem;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
    }

    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .form-check-label {
        font-weight: 500;
        margin-right: 0.75rem;
        color: #495057;
    }

    /* دکمه‌های ناوبری */
    .nav-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #e9ecef;
    }

    .btn-nav {
        padding: 0.75rem 2rem;
        border-radius: 0.75rem;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-prev {
        background-color: #f8f9fa;
        color: #495057;
    }

    .btn-next {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
    }

    .btn-nav:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* نشانگر مراحل */
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3rem;
        padding: 0 2rem;
        position: relative;
    }

    .step {
        text-align: center;
        flex: 1;
        position: relative;
        z-index: 1;
    }

    .step:not(:last-child):after {
        content: '';
        position: absolute;
        top: 50%;
        right: -50%;
        width: 100%;
        height: 3px;
        background: #e9ecef;
        z-index: 0;
        transition: all 0.3s ease;
    }

    .step.active:not(:last-child):after {
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #f8f9fa;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.75rem;
        position: relative;
        z-index: 2;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 2px solid #e9ecef;
    }

    .step.active .step-number {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        transform: scale(1.1);
    }

    .step-title {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .step.active .step-title {
        color: var(--primary-color);
        font-weight: 600;
    }

    /* پیام‌های خطا */
    .invalid-feedback {
        font-size: 0.875rem;
        color: #dc3545;
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        background-color: #fff5f5;
        border-radius: 0.5rem;
        border: 1px solid #ffcdd2;
    }

    /* انیمیشن‌ها */
    .form-page {
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
    }

    .form-page.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    /* استایل‌های واکنش‌گرا */
    @media (max-width: 768px) {
        .analysis-form {
            padding: 1.5rem;
        }

        .step-indicator {
            padding: 0 1rem;
        }

        .step-title {
            font-size: 0.75rem;
        }

        .btn-nav {
            padding: 0.5rem 1rem;
        }
    }

    /* استایل‌های خاص برای مناطق بلااستفاده */
    .unused-area-section {
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        padding: 2rem;
        border-radius: 1.25rem;
        margin-bottom: 2.5rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .unused-area-section:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .unused-area-header {
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(0, 0, 0, 0.05);
    }

    .unused-area-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 1rem;
        color: white;
        font-size: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .unused-area-title {
        color: #2c3e50;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        position: relative;
    }

    .unused-area-subtitle {
        color: #6c757d;
        font-size: 0.95rem;
        margin-top: 0.5rem;
        line-height: 1.6;
    }

    .unused-area-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .unused-area-option {
        position: relative;
        padding: 1.25rem;
        border-radius: 1rem;
        background: white;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .unused-area-option:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .unused-area-option.selected {
        border-color: var(--primary-color);
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
    }

    .unused-area-option input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .unused-area-option-label {
        display: flex;
        align-items: center;
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .unused-area-option-icon {
        width: 24px;
        height: 24px;
        margin-left: 0.75rem;
        color: var(--primary-color);
    }

    .unused-area-option-description {
        font-size: 0.875rem;
        color: #6c757d;
        line-height: 1.5;
    }

    .unused-area-fields {
        display: none;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        border: 1px solid #e9ecef;
    }

    .unused-area-fields.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    .unused-area-field-group {
        margin-bottom: 1.5rem;
    }

    .unused-area-field-group:last-child {
        margin-bottom: 0;
    }

    .unused-area-field-label {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        color: #2c3e50;
        font-weight: 500;
    }

    .unused-area-field-label i {
        margin-left: 0.5rem;
        color: var(--primary-color);
    }

    .unused-area-field-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e9ecef;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .unused-area-field-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        outline: none;
    }

    .unused-area-field-textarea {
        min-height: 120px;
        resize: vertical;
    }

    .unused-area-field-hint {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }

    @media (max-width: 768px) {
        .unused-area-section {
            padding: 1.5rem;
        }

        .unused-area-options {
            grid-template-columns: 1fr;
        }

        .unused-area-title {
            font-size: 1.25rem;
        }
    }

    /* استایل‌های کارت‌های انتخاب */
    .option-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 0.75rem;
        padding: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .option-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }

    .option-card .form-check {
        margin: 0;
    }

    .option-card .form-check-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #2c3e50;
        font-weight: 500;
        cursor: pointer;
    }

    .option-card .form-check-label i {
        color: var(--primary-color);
        font-size: 1.1rem;
    }

    .option-card .form-check-input:checked + .form-check-label {
        color: var(--primary-color);
    }

    /* استایل‌های tooltip */
    .tooltip {
        font-size: 0.875rem;
    }

    .tooltip-inner {
        background-color: #2c3e50;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
    }

    /* استایل‌های textarea */
    textarea.form-control {
        resize: none;
        border: 1px solid #e9ecef;
        border-radius: 0.75rem;
        padding: 1rem;
        transition: all 0.3s ease;
    }

    textarea.form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
    }

    /* Sales Data Section Styles */
    .sales-distribution {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .time-slot {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .time-slot:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .time-slot label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 8px;
        display: block;
    }

    .time-range-selector {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .progress {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .progress-bar {
        transition: width 0.6s ease;
    }

    .form-group {
        position: relative;
    }

    .form-group .form-text {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 5px;
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-color: #ced4da;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .time-slot {
            margin-bottom: 15px;
        }
        
        .sales-distribution {
            padding: 15px;
        }
    }

    /* استایل‌های مناطق بلااستفاده */
    .unused-area-item {
        transition: all 0.3s ease;
        border-left: 4px solid #007bff !important;
    }
    
    .unused-area-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    
    .unused-area-form {
        transition: all 0.3s ease;
    }
    
    .unused-area-form:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .badge {
        font-size: 0.75rem;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    /* انیمیشن برای اضافه کردن منطقه */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .unused-area-item {
        animation: slideIn 0.3s ease;
    }
    
    /* استایل برای فیلدهای اجباری */
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    /* بهبود ظاهر فرم */
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }
    
    /* بهبود ظاهر فیلدهای عددی */
    input[type="number"] {
        -moz-appearance: textfield;
    }
    
    /* فقط برای فیلدهای درصد spinner را حذف کنیم */
    input[name$="_sales_percent"]::-webkit-outer-spin-button,
    input[name$="_sales_percent"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    /* برای فیلد فروش روزانه spinner را نگه داریم */
    input[name="daily_sales"]::-webkit-outer-spin-button,
    input[name="daily_sales"]::-webkit-inner-spin-button {
        -webkit-appearance: auto;
    }
    
    /* استایل برای فیلدهای فروش */
    .sales-input-group {
        position: relative;
    }
    
    .sales-input-group .form-control:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    /* استایل برای نوار پیشرفت فروش */
    .sales-progress {
        height: 25px;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .sales-progress .progress-bar {
        transition: width 0.3s ease;
        font-size: 0.75rem;
        font-weight: bold;
    }
    
    /* استایل برای هشدارها */
    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }
    
    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    
    /* بهبود ظاهر select های زمان */
    .time-range-selector select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .time-range-selector select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* انیمیشن برای فیلدهای درصد */
    .time-slot input:focus {
        transform: scale(1.02);
        transition: transform 0.2s ease;
    }
    
    /* راهنمای کاربری */
    .user-guidance {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 0.9rem;
    }
    
    .user-guidance i {
        margin-left: 5px;
    }
    
    /* استایل‌های گام 4 - رفتار مشتری */
    .camera-settings,
    .video-settings {
        transition: all 0.3s ease;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        background-color: #f8f9fa;
    }
    
    .camera-settings.show,
    .video-settings.show {
        border-color: #007bff;
        background-color: #f0f8ff;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
    }
    
    /* استایل برای radio buttons در یک خط */
    .form-check {
        margin-bottom: 10px;
    }
    
    .form-check-input:checked {
        background-color: #007bff;
        border-color: #007bff;
    }
    
    .form-check-label {
        cursor: pointer;
        font-weight: 500;
    }
    
    .form-check-label i {
        margin-left: 5px;
        color: #6c757d;
    }
    
    /* استایل برای کارت‌های اطلاعات */
    .card-header h5 {
        color: #495057;
        font-weight: 600;
    }
    
    .card-header i {
        margin-left: 8px;
        color: #007bff;
    }
    
    /* بهبود ظاهر فیلدهای جدید */
    .customer-behavior-field {
        transition: all 0.3s ease;
    }
    
    .customer-behavior-field:focus {
        transform: scale(1.02);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* انیمیشن برای نمایش/مخفی کردن فرم‌ها */
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .camera-settings.show,
    .video-settings.show {
        animation: slideDown 0.3s ease;
    }
    
    /* استایل برای آیکون‌های مسیر حرکت */
    .movement-path-option {
        display: flex;
        align-items: center;
        padding: 10px;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .movement-path-option:hover {
        background-color: #f8f9fa;
        border-color: #007bff;
    }
    
    .movement-path-option input[type="radio"]:checked + label {
        color: #007bff;
        font-weight: 600;
    }
    
    .movement-path-option input[type="radio"]:checked + label i {
        color: #007bff;
    }
    
    /* بهبود فیلد فروش روزانه */
    #daily_sales {
        font-family: 'Courier New', monospace;
        font-size: 16px;
        font-weight: 500;
        text-align: left;
        direction: ltr;
    }
    
    #daily_sales:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        background-color: #fff;
    }
    
    #daily_sales.is-valid {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    
    #daily_sales.is-invalid {
        border-color: #dc3545;
        background-color: #fff8f8;
    }
    
    /* اطمینان از اینکه spinner کار می‌کند */
    #daily_sales::-webkit-outer-spin-button,
    #daily_sales::-webkit-inner-spin-button {
        opacity: 1;
        height: 20px;
        margin-right: 5px;
    }
    
    /* بهبود ظاهر input group */
    .sales-input-group .input-group-text {
        background-color: #f8f9fa;
        border-color: #ced4da;
        font-weight: 500;
    }
    
    .sales-input-group:focus-within .input-group-text {
        border-color: #28a745;
        background-color: #e8f5e8;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="analysis-form">
        <h2 class="text-center mb-5">فرم تحلیل رایگان فروشگاه</h2>
        
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-title">مشخصات پایه</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-title">نقشه و چیدمان</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-title">داده‌های فروش</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-title">رفتار مشتری</div>
            </div>
            <div class="step" data-step="5">
                <div class="step-number">5</div>
                <div class="step-title">طراحی و دکوراسیون</div>
            </div>
            <div class="step" data-step="6">
                <div class="step-number">6</div>
                <div class="step-title">فایل‌ها و تصاویر</div>
            </div>
        </div>

        <form id="analysisForm" enctype="multipart/form-data" method="post" action="{% url 'store_analysis:submit_analysis' %}" novalidate>
            {% csrf_token %}
            
            <!-- Page 1: Basic Information -->
            <div class="form-page active" id="page-1">
                <h3 class="form-section-title">مشخصات پایه فروشگاه</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.store_name.id_for_label }}" class="form-label required-field">نام فروشگاه</label>
                        {{ form.store_name }}
                        {% if form.store_name.errors %}
                            <div class="invalid-feedback">{{ form.store_name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.store_location.id_for_label }}" class="form-label required-field">موقعیت فروشگاه (شهر و منطقه)</label>
                        {{ form.store_location }}
                        {% if form.store_location.errors %}
                            <div class="invalid-feedback">{{ form.store_location.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.store_type.id_for_label }}" class="form-label required-field">نوع فروشگاه</label>
                        {{ form.store_type }}
                        {% if form.store_type.errors %}
                            <div class="invalid-feedback">{{ form.store_type.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.store_size.id_for_label }}" class="form-label required-field">متراژ فروشگاه (متر مربع)</label>
                        {{ form.store_size }}
                        {% if form.store_size.errors %}
                            <div class="invalid-feedback">{{ form.store_size.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.store_dimensions.id_for_label }}" class="form-label required-field">ابعاد فضای فروش (طول × عرض)</label>
                        {{ form.store_dimensions }}
                        {% if form.store_dimensions.errors %}
                            <div class="invalid-feedback">{{ form.store_dimensions.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.entrances.id_for_label }}" class="form-label required-field">ورودی‌های فروشگاه</label>
                        {{ form.entrances }}
                        {% if form.entrances.errors %}
                            <div class="invalid-feedback">{{ form.entrances.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.main_entrance.id_for_label }}" class="form-label required-field">ورودی اصلی</label>
                        {{ form.main_entrance }}
                        {% if form.main_entrance.errors %}
                            <div class="invalid-feedback">{{ form.main_entrance.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.customer_traffic.id_for_label }}" class="form-label required-field">ترافیک مشتری</label>
                        {{ form.customer_traffic }}
                        {% if form.customer_traffic.errors %}
                            <div class="invalid-feedback">{{ form.customer_traffic.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.main_lighting.id_for_label }}" class="form-label required-field">نورپردازی اصلی</label>
                        {{ form.main_lighting }}
                        {% if form.main_lighting.errors %}
                            <div class="invalid-feedback">{{ form.main_lighting.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Page 2: Layout and Shelving -->
            <div class="form-page" id="page-2">
                <h3 class="form-section-title">چیدمان و قفسه‌بندی</h3>
                
                <!-- مناطق بلااستفاده -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>مناطق بلااستفاده یا کم‌ترافیک</h4>
                        <p class="text-muted mb-0">مناطق مختلف را جداگانه اضافه کنید</p>
                        </div>
                    <div class="card-body">
                        <!-- لیست مناطق اضافه شده -->
                        <div id="unused-areas-list" class="mb-4">
                            <!-- مناطق اضافه شده اینجا نمایش داده می‌شوند -->
                    </div>

                        <!-- فرم اضافه کردن منطقه جدید -->
                        <div class="unused-area-form border rounded p-3 bg-light">
                            <h6 class="mb-3">افزودن منطقه جدید</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required-field">نوع منطقه</label>
                                    <select class="form-control" id="new-area-type">
                                        <option value="">انتخاب کنید</option>
                                        <option value="empty">منطقه خالی</option>
                                        <option value="low_traffic">کم‌ترافیک</option>
                                        <option value="storage">انبار</option>
                                        <option value="staff">فضای کارکنان</option>
                                        <option value="other">سایر</option>
                                    </select>
                    </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">متراژ (متر مربع)</label>
                                    <input type="number" class="form-control" id="new-area-size" min="0" placeholder="متراژ منطقه">
                            </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">دلیل بلااستفاده بودن</label>
                                    <textarea class="form-control" id="new-area-reason" rows="2" placeholder="دلیل بلااستفاده بودن منطقه را توضیح دهید"></textarea>
                            </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">توضیحات تکمیلی</label>
                                    <textarea class="form-control" id="new-area-description" rows="2" placeholder="توضیحات اضافی درباره منطقه"></textarea>
                            </div>
                    </div>
                            <button type="button" class="btn btn-primary" onclick="addUnusedArea()">
                                <i class="fas fa-plus"></i>
                                افزودن منطقه
                            </button>
                        </div>

                        <!-- فیلد مخفی برای ذخیره داده‌ها -->
                        <input type="hidden" name="unused_areas_data" id="unused-areas-data" value="">
                    </div>
                </div>

                <!-- سایر فیلدهای چیدمان -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.shelf_count.id_for_label }}" class="form-label required-field">تعداد قفسه اصلی</label>
                        {{ form.shelf_count }}
                        {% if form.shelf_count.errors %}
                            <div class="invalid-feedback">{{ form.shelf_count.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.shelf_dimensions.id_for_label }}" class="form-label required-field">ابعاد تقریبی هر قفسه</label>
                        {{ form.shelf_dimensions }}
                        {% if form.shelf_dimensions.errors %}
                            <div class="invalid-feedback">{{ form.shelf_dimensions.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="{{ form.shelf_contents.id_for_label }}" class="form-label required-field">محتوای قفسه‌ها</label>
                        {{ form.shelf_contents }}
                        {% if form.shelf_contents.errors %}
                            <div class="invalid-feedback">{{ form.shelf_contents.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.checkout_location.id_for_label }}" class="form-label required-field">محل صندوق‌های پرداخت</label>
                        {{ form.checkout_location }}
                        {% if form.checkout_location.errors %}
                            <div class="invalid-feedback">{{ form.checkout_location.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Page 3: Sales Data -->
            <div class="form-page" id="page-3">
                <h3 class="form-section-title">داده‌های فروش</h3>
                <!-- Sales Data Section -->
                <div class="row">
                    <!-- Daily Sales -->
                    <div class="col-md-6 mb-4">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-calendar-day"></i>
                                میانگین فروش روزانه (تومان)
                                <i class="fas fa-info-circle text-info" data-bs-toggle="tooltip" 
                                   title="مبلغ متوسط فروش در یک روز کاری معمولی را وارد کنید"></i>
                            </label>
                            <div class="input-group sales-input-group">
                                <input type="number" name="daily_sales" id="daily_sales" class="form-control" required
                                       min="1000000" step="100000" placeholder="مثال: 5000000" value="1000000"
                                       oninput="validateSalesAmount(this)" onkeypress="allowNumbersOnly(event)">
                                <span class="input-group-text">تومان</span>
                            </div>
                            <div class="form-text text-info">
                                <i class="fas fa-keyboard"></i> امکان تایپ مستقیم با کیبورد
                            </div>
                        </div>
                    </div>
                    <!-- Peak Hours -->
                    <div class="col-md-6 mb-4">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-clock"></i>
                                ساعات پیک فروش
                                <i class="fas fa-info-circle text-info" data-bs-toggle="tooltip" 
                                   title="ساعاتی که بیشترین فروش در آن‌ها انجام می‌شود"></i>
                            </label>
                            <div class="time-range-selector">
                                <div class="row">
                                    <div class="col-6">
                                        <select name="peak_hours_start" class="form-select" required>
                                            <option value="">از ساعت</option>
                                            {% for hour in "012345678901234567890123"|make_list %}
                                                {% if forloop.counter0 < 24 %}
                                                    <option value="{{ forloop.counter0|stringformat:'02d' }}:00">{{ forloop.counter0|stringformat:'02d' }}:00</option>
                                                    <option value="{{ forloop.counter0|stringformat:'02d' }}:30">{{ forloop.counter0|stringformat:'02d' }}:30</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select name="peak_hours_end" class="form-select" required>
                                            <option value="">تا ساعت</option>
                                            {% for hour in "012345678901234567890123"|make_list %}
                                                {% if forloop.counter0 < 24 %}
                                                    <option value="{{ forloop.counter0|stringformat:'02d' }}:00">{{ forloop.counter0|stringformat:'02d' }}:00</option>
                                                    <option value="{{ forloop.counter0|stringformat:'02d' }}:30">{{ forloop.counter0|stringformat:'02d' }}:30</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Sales Distribution -->
                    <div class="col-12 mb-4">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-chart-pie"></i>
                                توزیع فروش در ساعات مختلف
                                <i class="fas fa-info-circle text-info" data-bs-toggle="tooltip" 
                                   title="درصد فروش در هر بازه زمانی را مشخص کنید"></i>
                            </label>
                            <div class="sales-distribution">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <div class="time-slot">
                                            <label>صبح (8-12)</label>
                                            <div class="input-group">
                                                <input type="number" name="morning_sales_percent" class="form-control" 
                                                       required min="0" max="100" step="1" placeholder="درصد" 
                                                       oninput="validatePercentage(this)" onkeypress="allowNumbersOnly(event)">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="time-slot">
                                            <label>ظهر (12-16)</label>
                                            <div class="input-group">
                                                <input type="number" name="noon_sales_percent" class="form-control" 
                                                       required min="0" max="100" step="1" placeholder="درصد"
                                                       oninput="validatePercentage(this)" onkeypress="allowNumbersOnly(event)">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="time-slot">
                                            <label>عصر (16-20)</label>
                                            <div class="input-group">
                                                <input type="number" name="evening_sales_percent" class="form-control" 
                                                       required min="0" max="100" step="1" placeholder="درصد"
                                                       oninput="validatePercentage(this)" onkeypress="allowNumbersOnly(event)">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="time-slot">
                                            <label>شب (20-22)</label>
                                            <div class="input-group">
                                                <input type="number" name="night_sales_percent" class="form-control" 
                                                       required min="0" max="100" step="1" placeholder="درصد"
                                                       oninput="validatePercentage(this)" onkeypress="allowNumbersOnly(event)">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="progress mt-3" style="height: 20px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 25%">صبح</div>
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 25%">ظهر</div>
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 25%">عصر</div>
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 25%">شب</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Additional Sales Info -->
                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-comment-alt"></i>
                                توضیحات تکمیلی فروش
                                <i class="fas fa-info-circle text-info" data-bs-toggle="tooltip" 
                                   title="اطلاعات تکمیلی درباره الگوهای فروش و مشتریان"></i>
                            </label>
                            <textarea name="sales_additional_info" class="form-control" rows="3" 
                                      placeholder="توضیحات تکمیلی درباره الگوهای فروش، مشتریان خاص، یا شرایط خاص فروش..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 4: Customer Behavior -->
            <div class="form-page" id="page-4">
                <h3 class="form-section-title">رفتار مشتری</h3>
                
                <!-- دوربین نظارتی -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-video"></i>
                            دوربین نظارتی
                        </h5>
                    </div>
                    <div class="card-body">
                <div class="mb-3">
                    <label class="form-label required-field">آیا دوربین نظارتی دارید؟</label>
                            <div class="form-check">
                                <input type="radio" name="has_surveillance" value="yes" id="has_surveillance_yes" class="form-check-input" onchange="toggleCameraSettings()">
                                <label class="form-check-label" for="has_surveillance_yes">بله</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" name="has_surveillance" value="no" id="has_surveillance_no" class="form-check-input" onchange="toggleCameraSettings()">
                                <label class="form-check-label" for="has_surveillance_no">خیر</label>
                            </div>
                </div>

                        <div id="cameraSettings" class="camera-settings" style="display: none;">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="camera_count" class="form-label">تعداد دوربین‌ها</label>
                                    <input type="number" name="camera_count" id="camera_count" class="form-control" min="0" placeholder="تعداد دوربین‌ها">
                        </div>
                        <div class="col-md-8 mb-3">
                            <label for="camera_locations" class="form-label">موقعیت دوربین‌ها</label>
                                    <textarea name="camera_locations" id="camera_locations" class="form-control" rows="3" placeholder="موقعیت دقیق دوربین‌ها را توضیح دهید"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="camera_coverage" class="form-label">مناطق تحت پوشش</label>
                            <textarea name="camera_coverage" id="camera_coverage" class="form-control" rows="3" placeholder="مناطق تحت پوشش دوربین‌ها را توضیح دهید"></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="camera_quality" class="form-label">کیفیت تصویر</label>
                                    <select name="camera_quality" id="camera_quality" class="form-control">
                                        <option value="">انتخاب کنید</option>
                                        <option value="hd">HD (720p)</option>
                                        <option value="fullhd">Full HD (1080p)</option>
                                        <option value="4k">4K</option>
                                        <option value="other">سایر</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ویدیوی مسیر مشتری -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-video"></i>
                            ویدیوی مسیر مشتری
                        </h5>
                    </div>
                    <div class="card-body">
                <div class="mb-3">
                    <label class="form-label required-field">آیا ویدیوی مسیر مشتری دارید؟</label>
                            <div class="form-check">
                                <input type="radio" name="has_customer_video" value="yes" id="has_customer_video_yes" class="form-check-input" onchange="toggleVideoSettings()">
                                <label class="form-check-label" for="has_customer_video_yes">بله</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" name="has_customer_video" value="no" id="has_customer_video_no" class="form-check-input" onchange="toggleVideoSettings()">
                                <label class="form-check-label" for="has_customer_video_no">خیر</label>
                            </div>
                </div>

                        <div id="videoSettings" class="video-settings" style="display: none;">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="video_duration" class="form-label">مدت زمان ویدیو</label>
                            <input type="number" name="video_duration" id="video_duration" class="form-control" min="0" placeholder="ثانیه">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="video_date" class="form-label">تاریخ ضبط</label>
                            <input type="date" name="video_date" id="video_date" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="video_time" class="form-label">ساعت ضبط</label>
                            <input type="time" name="video_time" id="video_time" class="form-control">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="customer_video_file" class="form-label">آپلود فایل ویدیو</label>
                                    <input type="file" name="customer_video_file" id="customer_video_file" class="form-control" accept="video/*">
                                    <div class="form-text">فرمت‌های مجاز: MP4, AVI, MOV (حداکثر 100MB)</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="video_description" class="form-label">توضیحات ویدیو</label>
                                    <textarea name="video_description" id="video_description" class="form-control" rows="3" placeholder="توضیحات درباره محتوای ویدیو و شرایط ضبط"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- مسیر حرکت مشتری -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-route"></i>
                            مسیر حرکت مشتریان
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                        <label class="form-label required-field">مسیر معمول حرکت مشتریان</label>
                            <div class="row">
                                <div class="col-md-3">
                        <div class="form-check">
                            <input type="radio" name="customer_movement_paths" value="clockwise" id="customer_movement_paths_clockwise" class="form-check-input" required>
                                        <label class="form-check-label" for="customer_movement_paths_clockwise">
                                            <i class="fas fa-redo"></i> ساعتگرد
                                        </label>
                        </div>
                                </div>
                                <div class="col-md-3">
                        <div class="form-check">
                            <input type="radio" name="customer_movement_paths" value="counterclockwise" id="customer_movement_paths_counterclockwise" class="form-check-input" required>
                                        <label class="form-check-label" for="customer_movement_paths_counterclockwise">
                                            <i class="fas fa-undo"></i> پادساعتگرد
                                        </label>
                        </div>
                                </div>
                                <div class="col-md-3">
                        <div class="form-check">
                            <input type="radio" name="customer_movement_paths" value="mixed" id="customer_movement_paths_mixed" class="form-check-input" required>
                                        <label class="form-check-label" for="customer_movement_paths_mixed">
                                            <i class="fas fa-random"></i> مختلط
                                        </label>
                        </div>
                                </div>
                                <div class="col-md-3">
                        <div class="form-check">
                            <input type="radio" name="customer_movement_paths" value="random" id="customer_movement_paths_random" class="form-check-input" required>
                                        <label class="form-check-label" for="customer_movement_paths_random">
                                            <i class="fas fa-dice"></i> تصادفی
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- اطلاعات تکمیلی رفتار مشتری -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users"></i>
                            اطلاعات تکمیلی رفتار مشتری
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="avg_customer_time" class="form-label">میانگین زمان حضور مشتری (دقیقه)</label>
                                <input type="number" name="avg_customer_time" id="avg_customer_time" class="form-control" min="1" placeholder="مثال: 15">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="peak_customer_hours" class="form-label">ساعات پیک حضور مشتری</label>
                                <select name="peak_customer_hours" id="peak_customer_hours" class="form-control">
                                    <option value="">انتخاب کنید</option>
                                    <option value="morning">صبح (8-12)</option>
                                    <option value="noon">ظهر (12-16)</option>
                                    <option value="evening">عصر (16-20)</option>
                                    <option value="night">شب (20-22)</option>
                                    <option value="all_day">تمام روز</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customer_type" class="form-label">نوع غالب مشتریان</label>
                                <select name="customer_type" id="customer_type" class="form-control">
                                    <option value="">انتخاب کنید</option>
                                    <option value="individual">فردی</option>
                                    <option value="family">خانوادگی</option>
                                    <option value="group">گروهی</option>
                                    <option value="mixed">مختلط</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customer_age_group" class="form-label">گروه سنی غالب</label>
                                <select name="customer_age_group" id="customer_age_group" class="form-control">
                                    <option value="">انتخاب کنید</option>
                                    <option value="young">جوان (18-35)</option>
                                    <option value="middle">میانسال (35-50)</option>
                                    <option value="senior">سالمند (50+)</option>
                                    <option value="mixed">مختلط</option>
                                </select>
                            </div>
                        </div>
                <div class="row">
                    <div class="col-12 mb-3">
                                <label for="customer_behavior_patterns" class="form-label">الگوهای رفتاری مشتریان</label>
                                <textarea name="customer_behavior_patterns" id="customer_behavior_patterns" class="form-control" rows="3" placeholder="الگوهای رفتاری خاص مشتریان، نقاط توقف، مناطق مورد علاقه و..."></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="customer_path_notes" class="form-label required-field">توضیحات تکمیلی مسیر حرکت</label>
                        <textarea name="customer_path_notes" id="customer_path_notes" class="form-control" rows="3" placeholder="توضیحات تکمیلی درباره مسیر حرکت مشتریان" required></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 5: Design and Branding -->
            <div class="form-page" id="page-5">
                <h3 class="form-section-title">طراحی، برند و دکوراسیون</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.design_style.id_for_label }}" class="form-label required-field">سبک طراحی</label>
                        {{ form.design_style }}
                        {% if form.design_style.errors %}
                            <div class="invalid-feedback">{{ form.design_style.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.brand_colors.id_for_label }}" class="form-label required-field">رنگ‌های اصلی</label>
                        {{ form.brand_colors }}
                        {% if form.brand_colors.errors %}
                            <div class="invalid-feedback">{{ form.brand_colors.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="{{ form.decorative_elements.id_for_label }}" class="form-label">عناصر دکوراتیو</label>
                        {{ form.decorative_elements }}
                        {% if form.decorative_elements.errors %}
                            <div class="invalid-feedback">{{ form.decorative_elements.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="{{ form.layout_restrictions.id_for_label }}" class="form-label">محدودیت‌های چیدمان</label>
                        {{ form.layout_restrictions }}
                        {% if form.layout_restrictions.errors %}
                            <div class="invalid-feedback">{{ form.layout_restrictions.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Page 6: Files and Images -->
            <div class="form-page" id="page-6">
                <h3 class="form-section-title">فایل‌ها و تصاویر</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.store_plan.id_for_label }}" class="form-label required-field">نقشه فروشگاه</label>
                        {{ form.store_plan }}
                        {% if form.store_plan.errors %}
                            <div class="invalid-feedback">{{ form.store_plan.errors }}</div>
                        {% endif %}
                        <small class="form-text">فرمت‌های مجاز: JPG, PDF, DWG</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.store_photos.id_for_label }}" class="form-label required-field">عکس‌های فروشگاه</label>
                        {{ form.store_photos }}
                        {% if form.store_photos.errors %}
                            <div class="invalid-feedback">{{ form.store_photos.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.customer_video_file.id_for_label }}" class="form-label">ویدیوی مسیر مشتری</label>
                        {{ form.customer_video_file }}
                        {% if form.customer_video_file.errors %}
                            <div class="invalid-feedback">{{ form.customer_video_file.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.product_catalog.id_for_label }}" class="form-label">کاتالوگ محصولات</label>
                        {{ form.product_catalog }}
                        {% if form.product_catalog.errors %}
                            <div class="invalid-feedback">{{ form.product_catalog.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button type="button" class="btn btn-nav btn-prev" id="prevBtn" onclick="prevPage()">
                    <i class="fas fa-arrow-right"></i>
                    مرحله قبل
                </button>
                <button type="button" class="btn btn-nav btn-next" id="nextBtn" onclick="nextPage()">
                    مرحله بعد
                    <i class="fas fa-arrow-left"></i>
                </button>
                <button type="submit" class="btn btn-nav btn-next d-none" id="submitBtn">
                    ارسال نهایی
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentPage = 1;
const totalPages = 6;

function showPage(pageNumber) {
    // Hide all pages
    document.querySelectorAll('.form-page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Show current page
    document.getElementById(`page-${pageNumber}`).classList.add('active');
    
    // Update step indicator
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
    });
    document.querySelector(`.step[data-step="${pageNumber}"]`).classList.add('active');
    
    // Update navigation buttons
    document.getElementById('prevBtn').style.display = pageNumber === 1 ? 'none' : 'inline-block';
    document.getElementById('nextBtn').style.display = pageNumber === totalPages ? 'none' : 'inline-block';
    document.getElementById('submitBtn').classList.toggle('d-none', pageNumber !== totalPages);
}

function validatePage(pageNumber) {
    let valid = true;
    const currentPageElement = document.getElementById(`page-${pageNumber}`);
    
    // Check all required fields in the current page
    currentPageElement.querySelectorAll('input[required], select[required], textarea[required], input[data-required], textarea[data-required]').forEach(input => {
        if (!input.value) {
            input.classList.add('is-invalid');
            valid = false;
        } else {
            input.classList.remove('is-invalid');
        }
    });
    
    // Check checkboxes if they are required
    currentPageElement.querySelectorAll('input[type="checkbox"][name="unused_area_type"]').forEach(checkbox => {
        const checkboxGroup = checkbox.closest('.unused-area-options');
        if (checkboxGroup) {
            const checkedBoxes = checkboxGroup.querySelectorAll('input[type="checkbox"]:checked');
            if (checkedBoxes.length === 0) {
                checkboxGroup.classList.add('is-invalid');
                valid = false;
            } else {
                checkboxGroup.classList.remove('is-invalid');
            }
        }
    });
    
    return valid;
}

function nextPage() {
    if (validatePage(currentPage)) {
        currentPage++;
        showPage(currentPage);
    } else {
        alert('لطفاً تمام فیلدهای اجباری را پر کنید.');
    }
}

function prevPage() {
    currentPage--;
    showPage(currentPage);
}

// Initialize the form
showPage(1);

// Handle form submission
document.getElementById('analysisForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    // Validate all pages before submission
    let allValid = true;
    for (let i = 1; i <= totalPages; i++) {
        if (!validatePage(i)) {
            allValid = false;
            showPage(i);
            break;
        }
    }
    
    if (!allValid) {
        alert('لطفاً تمام فیلدهای اجباری را پر کنید.');
        return;
    }
    
    const formData = new FormData(this);
    
    // Add selected unused area types to formData
    const selectedTypes = [];
    document.querySelectorAll('input[name="unused_area_type"]:checked').forEach(checkbox => {
        selectedTypes.push(checkbox.value);
    });
    formData.set('unused_area_type', JSON.stringify(selectedTypes));
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'در حال ارسال...';
    
    fetch('{% url "store_analysis:submit_analysis" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            window.location.href = data.redirect_url;
        } else {
            let errorMessage = 'خطا در ارسال فرم:\n';
            if (data.errors) {
                for (const [field, errors] of Object.entries(data.errors)) {
                    errorMessage += `\n${field}: ${errors.join(', ')}`;
                }
            } else {
                errorMessage += data.message || 'خطای نامشخص';
            }
            console.error('Form submission error:', data);
            alert(errorMessage);
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('خطا در ارسال فرم. لطفاً دوباره تلاش کنید.\n' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
});

// Handle conditional fields
document.querySelectorAll('input[name="has_surveillance"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('cameraSettings').style.display = this.value === 'yes' ? 'block' : 'none';
    });
});

document.querySelectorAll('input[name="has_customer_video"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('videoSettings').style.display = this.value === 'yes' ? 'block' : 'none';
    });
});

// Initialize conditional fields
document.addEventListener('DOMContentLoaded', function() {
    const hasSurveillance = document.querySelector('input[name="has_surveillance"]:checked');
    const hasCustomerVideo = document.querySelector('input[name="has_customer_video"]:checked');
    
    if (hasSurveillance) {
        document.getElementById('cameraSettings').style.display = hasSurveillance.value === 'yes' ? 'block' : 'none';
    }
    
    if (hasCustomerVideo) {
        document.getElementById('videoSettings').style.display = hasCustomerVideo.value === 'yes' ? 'block' : 'none';
    }
});

// Handle unused area type selection with improved UX
document.querySelectorAll('input[name="unused_area_type"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const unusedAreaFields = document.querySelector('.unused-area-fields');
        const unusedAreaSize = document.querySelector('input[name="unused_area_size"]');
        const unusedAreaReason = document.querySelector('textarea[name="unused_area_reason"]');
        const unusedAreas = document.querySelector('textarea[name="unused_areas"]');
        
        // Count selected checkboxes
        const selectedCount = document.querySelectorAll('input[name="unused_area_type"]:checked').length;
        
        if (selectedCount > 0) {
            if (unusedAreaSize) {
                unusedAreaSize.required = true;
                unusedAreaSize.setAttribute('data-required', 'true');
            }
            if (unusedAreaReason) {
                unusedAreaReason.required = true;
                unusedAreaReason.setAttribute('data-required', 'true');
            }
            if (unusedAreas) {
                unusedAreas.required = false;
                unusedAreas.removeAttribute('data-required');
            }
            
            // Show the fields with animation
            unusedAreaFields.classList.add('show');
        } else {
            if (unusedAreaSize) {
                unusedAreaSize.required = false;
                unusedAreaSize.removeAttribute('data-required');
            }
            if (unusedAreaReason) {
                unusedAreaReason.required = false;
                unusedAreaReason.removeAttribute('data-required');
            }
            if (unusedAreas) {
                unusedAreas.required = false;
                unusedAreas.removeAttribute('data-required');
            }
            
            // Hide the fields with animation
            unusedAreaFields.classList.remove('show');
        }
    });
});

// Initialize tooltips and form
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            trigger: 'hover',
            placement: 'top',
            html: true
        });
    });
    
    // Initialize unused areas management
    initializeUnusedAreas();
});

// مدیریت مناطق بلااستفاده چندگانه
let unusedAreas = [];

function initializeUnusedAreas() {
    // بارگذاری مناطق ذخیره شده (اگر وجود داشته باشد)
    const savedData = document.getElementById('unused-areas-data').value;
    if (savedData) {
        try {
            unusedAreas = JSON.parse(savedData);
            renderUnusedAreas();
        } catch (e) {
            console.error('خطا در بارگذاری داده‌های مناطق:', e);
        }
    }
}

function addUnusedArea() {
    const type = document.getElementById('new-area-type').value;
    const size = document.getElementById('new-area-size').value;
    const reason = document.getElementById('new-area-reason').value;
    const description = document.getElementById('new-area-description').value;
    
    if (!type) {
        alert('لطفاً نوع منطقه را انتخاب کنید.');
        return;
    }
    
    const area = {
        id: Date.now(),
        type: type,
        size: size,
        reason: reason,
        description: description,
        createdAt: new Date().toISOString()
    };
    
    unusedAreas.push(area);
    renderUnusedAreas();
    clearUnusedAreaForm();
    updateUnusedAreasData();
}

function removeUnusedArea(id) {
    unusedAreas = unusedAreas.filter(area => area.id !== id);
    renderUnusedAreas();
    updateUnusedAreasData();
}

function clearUnusedAreaForm() {
    document.getElementById('new-area-type').value = '';
    document.getElementById('new-area-size').value = '';
    document.getElementById('new-area-reason').value = '';
    document.getElementById('new-area-description').value = '';
}

function renderUnusedAreas() {
    const container = document.getElementById('unused-areas-list');
    container.innerHTML = '';
    
    if (unusedAreas.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3">هنوز منطقه‌ای اضافه نشده است</div>';
        return;
    }
    
    unusedAreas.forEach(area => {
        const areaElement = createUnusedAreaElement(area);
        container.appendChild(areaElement);
    });
}

function createUnusedAreaElement(area) {
    const areaTypes = {
        'empty': 'منطقه خالی',
        'low_traffic': 'کم‌ترافیک',
        'storage': 'انبار',
        'staff': 'فضای کارکنان',
        'other': 'سایر'
    };
    
    const div = document.createElement('div');
    div.className = 'unused-area-item border rounded p-3 mb-3 bg-white';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-primary me-2">${areaTypes[area.type]}</span>
                    ${area.size ? `<span class="badge bg-info me-2">${area.size} متر مربع</span>` : ''}
                </div>
                ${area.reason ? `<p class="mb-2"><strong>دلیل:</strong> ${area.reason}</p>` : ''}
                ${area.description ? `<p class="mb-0 text-muted"><small>${area.description}</small></p>` : ''}
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeUnusedArea(${area.id})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    return div;
}

function updateUnusedAreasData() {
    document.getElementById('unused-areas-data').value = JSON.stringify(unusedAreas);
}

// توابع جدید برای بهبود تجربه کاربری در گام 3
function validatePercentage(input) {
    let value = parseInt(input.value);
    if (value < 0) {
        input.value = 0;
    } else if (value > 100) {
        input.value = 100;
    }
    updateSalesProgress();
}

function allowNumbersOnly(event) {
    const charCode = (event.which) ? event.which : event.keyCode;
    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
        event.preventDefault();
        return false;
    }
    return true;
}

function updateSalesProgress() {
    const morning = parseInt(document.querySelector('input[name="morning_sales_percent"]').value) || 0;
    const noon = parseInt(document.querySelector('input[name="noon_sales_percent"]').value) || 0;
    const evening = parseInt(document.querySelector('input[name="evening_sales_percent"]').value) || 0;
    const night = parseInt(document.querySelector('input[name="night_sales_percent"]').value) || 0;
    
    const total = morning + noon + evening + night;
    
    // به‌روزرسانی نوار پیشرفت
    const progressBars = document.querySelectorAll('.progress-bar');
    if (progressBars.length >= 4) {
        progressBars[0].style.width = `${morning}%`;
        progressBars[1].style.width = `${noon}%`;
        progressBars[2].style.width = `${evening}%`;
        progressBars[3].style.width = `${night}%`;
    }
    
    // نمایش هشدار اگر مجموع بیش از 100% باشد
    const totalElement = document.getElementById('sales-total');
    if (!totalElement) {
        const totalDiv = document.createElement('div');
        totalDiv.id = 'sales-total';
        totalDiv.className = 'mt-2';
        document.querySelector('.sales-distribution').appendChild(totalDiv);
    }
    
    const totalDiv = document.getElementById('sales-total');
        if (total > 100) {
        totalDiv.innerHTML = `<div class="alert alert-warning py-2 mb-0">
            <i class="fas fa-exclamation-triangle"></i>
            مجموع درصدها (${total}%) بیش از 100% است!
        </div>`;
    } else if (total < 100) {
        totalDiv.innerHTML = `<div class="text-muted">
            مجموع: ${total}% (${100 - total}% باقی‌مانده)
        </div>`;
    } else {
        totalDiv.innerHTML = `<div class="text-success">
            <i class="fas fa-check-circle"></i>
            مجموع: 100% ✓
        </div>`;
    }
}

// بهبود فیلد فروش روزانه
function formatSalesInput(input) {
    let value = input.value.replace(/[^\d]/g, '');
    if (value.length > 0) {
        value = parseInt(value);
        if (value < 1000000) {
            value = 1000000;
        }
        input.value = value.toLocaleString('fa-IR');
    }
}

function unformatSalesInput(input) {
    input.value = input.value.replace(/[^\d]/g, '');
}

// اعتبارسنجی زمان‌ها
function validateTimeRange() {
    const startTime = document.querySelector('select[name="peak_hours_start"]').value;
    const endTime = document.querySelector('select[name="peak_hours_end"]').value;
    
    if (startTime && endTime) {
        const start = convertTimeToMinutes(startTime);
        const end = convertTimeToMinutes(endTime);
        
        if (start >= end) {
            alert('زمان پایان باید بعد از زمان شروع باشد.');
            return false;
        }
    }
    return true;
}

function convertTimeToMinutes(timeStr) {
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + (minutes || 0);
}

// بهبود تجربه کاربری برای فیلدهای عددی
document.addEventListener('DOMContentLoaded', function() {
    // بهبود فیلد فروش روزانه
    const salesInput = document.querySelector('input[name="daily_sales"]');
    if (salesInput) {
        // حذف event listeners قبلی که ممکن است تداخل ایجاد کنند
        salesInput.removeEventListener('focus', unformatSalesInput);
        salesInput.removeEventListener('blur', formatSalesInput);
        salesInput.removeEventListener('input', validateSalesAmount);
        
        // اضافه کردن event listeners جدید
        salesInput.addEventListener('input', function() {
            validateSalesAmount(this);
        });
        
        // اطمینان از اینکه فیلد قابل تایپ است
        salesInput.removeAttribute('readonly');
        salesInput.removeAttribute('disabled');
    }
    
    // بهبود فیلدهای درصد
    const percentageInputs = document.querySelectorAll('input[name$="_sales_percent"]');
    percentageInputs.forEach(input => {
        input.addEventListener('input', function() {
            validatePercentage(this);
        });
        
        input.addEventListener('keypress', function(event) {
            allowNumbersOnly(event);
        });
    });
    
    // اعتبارسنجی زمان‌ها
    const timeSelects = document.querySelectorAll('select[name^="peak_hours"]');
    timeSelects.forEach(select => {
        select.addEventListener('change', validateTimeRange);
    });
    
    // راهنمای کاربری
    addUserGuidance();
    
    // راه‌اندازی فرم‌های گام 4
    initializeStep4Forms();
});

function initializeStep4Forms() {
    // بررسی وضعیت اولیه فرم‌های دوربین و ویدیو
    const hasSurveillance = document.querySelector('input[name="has_surveillance"]:checked');
    const hasCustomerVideo = document.querySelector('input[name="has_customer_video"]:checked');
    
    if (hasSurveillance) {
        toggleCameraSettings();
    }
    
    if (hasCustomerVideo) {
        toggleVideoSettings();
    }
    
    // اضافه کردن event listeners برای radio buttons
    const surveillanceRadios = document.querySelectorAll('input[name="has_surveillance"]');
    surveillanceRadios.forEach(radio => {
        radio.addEventListener('change', toggleCameraSettings);
    });
    
    const videoRadios = document.querySelectorAll('input[name="has_customer_video"]');
    videoRadios.forEach(radio => {
        radio.addEventListener('change', toggleVideoSettings);
    });
    
    // تست فیلد فروش روزانه
    testDailySalesField();
}

// تابع تست برای فیلد فروش روزانه
function testDailySalesField() {
    const salesInput = document.getElementById('daily_sales');
    if (salesInput) {
        console.log('فیلد فروش روزانه پیدا شد:', salesInput);
        console.log('نوع فیلد:', salesInput.type);
        console.log('قابلیت تایپ:', !salesInput.readOnly && !salesInput.disabled);
        
        // تست تایپ مستقیم
        salesInput.addEventListener('keydown', function(e) {
            console.log('کلید فشرده شده:', e.key);
        });
        
        // تست تغییر مقدار
        salesInput.addEventListener('input', function(e) {
            console.log('مقدار جدید:', e.target.value);
        });
    } else {
        console.error('فیلد فروش روزانه پیدا نشد!');
    }
}

function addUserGuidance() {
    // اضافه کردن راهنمای کاربری برای فیلدهای مهم
    const salesInput = document.querySelector('input[name="daily_sales"]');
    if (salesInput) {
        const helpText = document.createElement('div');
        helpText.className = 'form-text text-info';
        helpText.innerHTML = '<i class="fas fa-info-circle"></i> می‌توانید مستقیماً با کیبورد تایپ کنید';
        salesInput.parentNode.appendChild(helpText);
    }
}

// اعتبارسنجی مبلغ فروش روزانه
function validateSalesAmount(input) {
    let value = parseInt(input.value) || 0;
    
    // حذف کلاس‌های قبلی
    input.classList.remove('is-invalid', 'is-valid');
    
    if (value < 1000000) {
        input.setCustomValidity('حداقل مبلغ 1,000,000 تومان باید باشد.');
        input.classList.add('is-invalid');
    } else {
        input.setCustomValidity('');
        input.classList.add('is-valid');
    }
    
    // اطمینان از اینکه فیلد قابل تایپ است
    input.removeAttribute('readonly');
    input.removeAttribute('disabled');
}

// توابع مدیریت فرم‌های گام 4
function toggleCameraSettings() {
    const cameraSettings = document.getElementById('cameraSettings');
    const hasSurveillance = document.querySelector('input[name="has_surveillance"]:checked');
    
    if (hasSurveillance && hasSurveillance.value === 'yes') {
        cameraSettings.style.display = 'block';
        cameraSettings.classList.add('show');
        // اطمینان از اینکه فیلدها الزامی هستند
        const cameraCount = document.getElementById('camera_count');
        const cameraLocations = document.getElementById('camera_locations');
        const cameraCoverage = document.getElementById('camera_coverage');
        
        if (cameraCount) cameraCount.required = true;
        if (cameraLocations) cameraLocations.required = true;
        if (cameraCoverage) cameraCoverage.required = true;
    } else {
        cameraSettings.style.display = 'none';
        cameraSettings.classList.remove('show');
        // حذف الزامی بودن فیلدها
        const cameraCount = document.getElementById('camera_count');
        const cameraLocations = document.getElementById('camera_locations');
        const cameraCoverage = document.getElementById('camera_coverage');
        
        if (cameraCount) {
            cameraCount.required = false;
            cameraCount.value = '';
        }
        if (cameraLocations) {
            cameraLocations.required = false;
            cameraLocations.value = '';
        }
        if (cameraCoverage) {
            cameraCoverage.required = false;
            cameraCoverage.value = '';
        }
    }
}

function toggleVideoSettings() {
    const videoSettings = document.getElementById('videoSettings');
    const hasCustomerVideo = document.querySelector('input[name="has_customer_video"]:checked');
    
    if (hasCustomerVideo && hasCustomerVideo.value === 'yes') {
        videoSettings.style.display = 'block';
        videoSettings.classList.add('show');
        // اطمینان از اینکه فیلدها الزامی هستند
        const videoDuration = document.getElementById('video_duration');
        const videoDate = document.getElementById('video_date');
        
        if (videoDuration) videoDuration.required = true;
        if (videoDate) videoDate.required = true;
    } else {
        videoSettings.style.display = 'none';
        videoSettings.classList.remove('show');
        // حذف الزامی بودن فیلدها
        const videoDuration = document.getElementById('video_duration');
        const videoDate = document.getElementById('video_date');
        
        if (videoDuration) {
            videoDuration.required = false;
            videoDuration.value = '';
        }
        if (videoDate) {
            videoDate.required = false;
            videoDate.value = '';
        }
    }
}
</script>
{% endblock %} 
