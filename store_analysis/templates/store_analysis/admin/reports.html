{% extends "store_analysis/admin/base.html" %}
{% load static %}

{% block admin_content %}
<!-- Header -->
<div class="admin-header">
    <div class="page-title">
        <div class="page-icon">
            <i class="fas fa-chart-bar"></i>
        </div>
        گزارش‌های تحلیلی
    </div>
    <div class="admin-actions">
        <a href="#" class="btn-admin btn-primary" onclick="generateReport()">
            <i class="fas fa-file-pdf"></i>
            تولید گزارش PDF
        </a>
        <a href="#" class="btn-admin btn-success" onclick="exportExcel()">
            <i class="fas fa-file-excel"></i>
            خروجی Excel
        </a>
    </div>
</div>

<!-- Report Filters -->
<div class="content-card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-filter"></i>
            فیلتر گزارش‌ها
        </div>
    </div>
    
    <form method="GET" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div class="form-group">
            <label class="form-label">نوع گزارش</label>
            <select name="type" class="form-control" onchange="loadReportData()">
                <option value="overview" {% if report_type == 'overview' %}selected{% endif %}>گزارش کلی</option>
                <option value="users" {% if report_type == 'users' %}selected{% endif %}>گزارش کاربران</option>
                <option value="analyses" {% if report_type == 'analyses' %}selected{% endif %}>گزارش تحلیل‌ها</option>
                <option value="revenue" {% if report_type == 'revenue' %}selected{% endif %}>گزارش درآمد</option>
                <option value="tickets" {% if report_type == 'tickets' %}selected{% endif %}>گزارش تیکت‌ها</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">از تاریخ</label>
            <input type="date" name="start_date" class="form-control" value="{{ start_date|default:'' }}">
        </div>
        
        <div class="form-group">
            <label class="form-label">تا تاریخ</label>
            <input type="date" name="end_date" class="form-control" value="{{ end_date|default:'' }}">
        </div>
        
        <div class="form-group">
            <label class="form-label">دوره زمانی</label>
            <select name="period" class="form-control">
                <option value="daily">روزانه</option>
                <option value="weekly">هفتگی</option>
                <option value="monthly">ماهانه</option>
                <option value="yearly">سالانه</option>
            </select>
        </div>
        
        <div class="form-group" style="display: flex; align-items: end;">
            <button type="submit" class="btn-admin btn-primary">
                <i class="fas fa-search"></i>
                اعمال فیلتر
            </button>
        </div>
    </form>
</div>

<!-- Overview Report -->
{% if report_type == 'overview' %}
<div class="content-card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-tachometer-alt"></i>
            گزارش کلی سیستم
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="text-align: center; padding: 25px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
            <div style="font-size: 2.5rem; font-weight: 800; color: #4CAF50; margin-bottom: 10px;">1,234</div>
            <div style="color: rgba(255, 255, 255, 0.8); font-size: 1rem; margin-bottom: 5px;">کل کاربران</div>
            <div style="color: #4CAF50; font-size: 0.9rem;">+12% نسبت به ماه قبل</div>
        </div>
        
        <div style="text-align: center; padding: 25px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
            <div style="font-size: 2.5rem; font-weight: 800; color: #2196F3; margin-bottom: 10px;">856</div>
            <div style="color: rgba(255, 255, 255, 0.8); font-size: 1rem; margin-bottom: 5px;">تحلیل‌های انجام شده</div>
            <div style="color: #2196F3; font-size: 0.9rem;">+8% نسبت به ماه قبل</div>
        </div>
        
        <div style="text-align: center; padding: 25px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
            <div style="font-size: 2.5rem; font-weight: 800; color: #FF9800; margin-bottom: 10px;">45,600,000</div>
            <div style="color: rgba(255, 255, 255, 0.8); font-size: 1rem; margin-bottom: 5px;">کل درآمد (تومان)</div>
            <div style="color: #FF9800; font-size: 0.9rem;">+15% نسبت به ماه قبل</div>
        </div>
        
        <div style="text-align: center; padding: 25px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
            <div style="font-size: 2.5rem; font-weight: 800; color: #9C27B0; margin-bottom: 10px;">98.5%</div>
            <div style="color: rgba(255, 255, 255, 0.8); font-size: 1rem; margin-bottom: 5px;">رضایت کاربران</div>
            <div style="color: #9C27B0; font-size: 0.9rem;">+2% نسبت به ماه قبل</div>
        </div>
    </div>
    
    <!-- Charts -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div>
            <h4 style="color: white; margin-bottom: 15px;">روند کاربران</h4>
            <canvas id="usersChart" style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px;"></canvas>
        </div>
        
        <div>
            <h4 style="color: white; margin-bottom: 15px;">روند درآمد</h4>
            <canvas id="revenueChart" style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px;"></canvas>
        </div>
    </div>
</div>
{% endif %}

<!-- Users Report -->
{% if report_type == 'users' %}
<div class="content-card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-users"></i>
            گزارش کاربران
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>دوره</th>
                    <th>کاربران جدید</th>
                    <th>کاربران فعال</th>
                    <th>نرخ رشد</th>
                    <th>نرخ نگهداری</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data %}
                <tr>
                    <td>{{ item.month }}</td>
                    <td>{{ item.count }}</td>
                    <td>{{ item.active_count|default:item.count }}</td>
                    <td>
                        <span style="color: {% if item.growth_rate > 0 %}#4CAF50{% else %}#F44336{% endif %};">
                            {% if item.growth_rate > 0 %}+{% endif %}{{ item.growth_rate|default:0 }}%
                        </span>
                    </td>
                    <td>{{ item.retention_rate|default:85 }}%</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        هیچ داده‌ای یافت نشد
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Analyses Report -->
{% if report_type == 'analyses' %}
<div class="content-card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-chart-line"></i>
            گزارش تحلیل‌ها
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>دوره</th>
                    <th>تحلیل‌های انجام شده</th>
                    <th>تحلیل‌های تکمیل شده</th>
                    <th>نرخ موفقیت</th>
                    <th>میانگین زمان</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data %}
                <tr>
                    <td>{{ item.month }}</td>
                    <td>{{ item.count }}</td>
                    <td>{{ item.completed_count|default:item.count }}</td>
                    <td>
                        <span style="color: {% if item.success_rate > 80 %}#4CAF50{% elif item.success_rate > 60 %}#FF9800{% else %}#F44336{% endif %};">
                            {{ item.success_rate|default:95 }}%
                        </span>
                    </td>
                    <td>{{ item.avg_time|default:"15 دقیقه" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
                        <i class="fas fa-chart-line" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        هیچ داده‌ای یافت نشد
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Revenue Report -->
{% if report_type == 'revenue' %}
<div class="content-card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-dollar-sign"></i>
            گزارش درآمد
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>دوره</th>
                    <th>کل درآمد</th>
                    <th>تعداد سفارشات</th>
                    <th>میانگین سفارش</th>
                    <th>نرخ رشد</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data %}
                <tr>
                    <td>{{ item.month }}</td>
                    <td>{{ item.total|floatformat:0 }} تومان</td>
                    <td>{{ item.orders_count|default:item.count }}</td>
                    <td>{{ item.avg_order|default:50000|floatformat:0 }} تومان</td>
                    <td>
                        <span style="color: {% if item.growth_rate > 0 %}#4CAF50{% else %}#F44336{% endif %};">
                            {% if item.growth_rate > 0 %}+{% endif %}{{ item.growth_rate|default:0 }}%
                        </span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
                        <i class="fas fa-dollar-sign" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        هیچ داده‌ای یافت نشد
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Export Options -->
<div class="content-card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-download"></i>
            گزینه‌های خروجی
        </div>
    </div>
    
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <a href="#" class="btn-admin btn-primary" onclick="exportPDF()">
            <i class="fas fa-file-pdf"></i>
            خروجی PDF
        </a>
        
        <a href="#" class="btn-admin btn-success" onclick="exportExcel()">
            <i class="fas fa-file-excel"></i>
            خروجی Excel
        </a>
        
        <a href="#" class="btn-admin btn-warning" onclick="exportCSV()">
            <i class="fas fa-file-csv"></i>
            خروجی CSV
        </a>
        
        <a href="#" class="btn-admin btn-primary" onclick="sendEmail()">
            <i class="fas fa-envelope"></i>
            ارسال ایمیل
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
function loadReportData() {
    const reportType = document.querySelector('select[name="type"]').value;
    const url = new URL(window.location);
    url.searchParams.set('type', reportType);
    window.location.href = url.toString();
}

function generateReport() {
    showNotification('گزارش در حال تولید...', 'info');
}

function exportPDF() {
    showNotification('خروجی PDF در حال آماده‌سازی...', 'info');
}

function exportExcel() {
    showNotification('خروجی Excel در حال آماده‌سازی...', 'info');
}

function exportCSV() {
    showNotification('خروجی CSV در حال آماده‌سازی...', 'info');
}

function sendEmail() {
    showNotification('گزارش در حال ارسال...', 'info');
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        background: ${type === 'success' ? '#4CAF50' : type === 'warning' ? '#FF9800' : type === 'error' ? '#F44336' : '#2196F3'};
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Initialize charts for overview report
{% if report_type == 'overview' %}
document.addEventListener('DOMContentLoaded', function() {
    // Users Chart
    const usersCtx = document.getElementById('usersChart').getContext('2d');
    new Chart(usersCtx, {
        type: 'line',
        data: {
            labels: ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور'],
            datasets: [{
                label: 'کاربران جدید',
                data: [120, 150, 180, 200, 220, 250],
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.8)'
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            }
        }
    });

    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور'],
            datasets: [{
                label: 'درآمد (میلیون تومان)',
                data: [5.2, 6.8, 7.5, 8.2, 9.1, 10.5],
                backgroundColor: 'rgba(33, 150, 243, 0.8)',
                borderColor: '#2196F3',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.8)'
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            }
        }
    });
});
{% endif %}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
