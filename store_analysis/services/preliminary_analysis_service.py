"""
Preliminary Analysis Service - ุชุญูู ุงููู ุฑุงฺฏุงู
"""

import logging
from typing import Dict, Any
from datetime import datetime

logger = logging.getLogger(__name__)


class PreliminaryAnalysisService:
    """ุณุฑูุณ ุชููุฏ ุชุญูู ุงููู (ูุฏุฑุช) ุฑุงฺฏุงู"""
    
    # ูุงูุจโูุง ุชุญูู ุงููู ุจุฑ ุงุณุงุณ ููุน ูุฑูุดฺฏุงู
    STORE_TYPE_TEMPLATES = {
        'clothing_store': {
            'name': 'ูพูุดุงฺฉ',
            'template': """
๐น **ุงุทูุงุนุงุช ูพุงู:**
- ูุงู ูุฑูุดฺฏุงู: {store_name}
- ููุน ูุฑูุดฺฏุงู: {store_type_fa}
- ูุชุฑุงฺ: {store_size} ูุชุฑ ูุฑุจุน
- ูฺฉุงู: {location}
- ุชุงุฑุฎ ุชุญูู: {analysis_date}

๐ **ุฎูุงุตู ูุฏุฑุช:**
ุชุญูู ููุดููุฏ ฺุฏูุงู ูุฑูุดฺฏุงู {store_name} ูุดุงู ูโุฏูุฏ ฺฉู ุงูฺฏู ุฌุฑุงู ูุดุชุฑ ูุงุจู ุจูุจูุฏ ุงุณุช ู ุจุง ุงุตูุงุญุงุช ูพุดููุงุฏุ ูโุชูุงู ูพุชุงูุณู ูุฑูุด ุฑุง ุชุง **15-20%** ุงูุฒุงุด ุฏุงุฏ.

**ุงูุชุงุฒ ฺฉู ุจูุฑูโูุฑ ฺุฏูุงู:** โญ {score} ุงุฒ 100

๐ **ุชุญูู ูู ฺุฏูุงู:**

| ุดุงุฎุต | ูุถุนุช ูุนู | ูุงูฺฏู ุตูุนุช | ุชูุตู |
|------|------------|--------------|-------|
| ูุณุฑ ุญุฑฺฉุช ูุดุชุฑ | ูุชูุณุท | ุฎูุจ | ุจูููโุณุงุฒ ูุณุฑ ุงุตู |
| ูุณุจุช ูุถุง ููุงุด | ูุงุจู ูุจูู | ุฎูุจ | ุงูุฒุงุด 10% ูุถุง ููุงุด |
| ููุฑ ู ุฑูฺฏ | ูุชูุณุท | ุฎูุจ | ุจูุจูุฏ ุฑูุดูุง |
| ุตูุฏูู ู ุฎุฑูุฌ | ูุงุจู ูุจูู | ุฎูุจ | ุจูููโุณุงุฒ ูููุนุช |

๐ฅ **ุชุญูู ุฑูุชุงุฑ ูุดุชุฑ:**
- ุงูฺฏู ุญุฑฺฉุช ูุดุชุฑุงู ูุงุจู ุจูุจูุฏ ุงุณุช
- ุชูุฌู ุจู ููุงุท ูพุฑุชุฑุฏุฏ ู ฺฉูโุชุฑุฏุฏ
- ุจูููโุณุงุฒ ฺุฏูุงู ุจุฑ ุงุณุงุณ ูุญุตููุงุช ูพุฑูุฑูุด

๐จ **ุชุญูู ุฏฺฉูุฑ ู ููุฑ:**
- ุชุฑฺฉุจ ุฑูฺฏโูุง ูุงุฒ ุจู ุจุฑุฑุณ ุจุดุชุฑ ุฏุงุฑุฏ
- ูุฒุงู ุฑูุดูุง ุจุงุฏ ุงุณุชุงูุฏุงุฑุฏ ุดูุฏ
- ุฏฺฉูุฑุงุณูู ูุชูุงุณุจ ุจุง ุจุฑูุฏ ุชูุตู ูโุดูุฏ

๐ง **ุชูุตูโูุง ฺฉูุฏ:**
1. ุจุงุฒุทุฑุงุญ ูุณุฑ ุงุตู ูุฑูุดฺฏุงู
2. ุงุฌุงุฏ ููุงุท ุฌุฐุจ ุจุฑุง ูุญุตููุงุช ูพุฑูุฑูุด
3. ุงูุฒุงุด ููุฑ ูุญุท ุฏุฑ ููุงุญ ฺฉูโุฏุฏ
4. ุจูููโุณุงุฒ ูููุนุช ุตูุฏูู ูพุฑุฏุงุฎุช

๐ **ูพุดโุจู ุฑุดุฏ:**
ุจุง ุงุฌุฑุง ูพุดููุงุฏุงุชุ ุงูุชุธุงุฑ ูโุฑูุฏ:
- โ ุงูุฒุงุด ูุฑูุด ุฑูุฒุงูู: **+15-18%**
- โ ุงูุฒุงุด ุฒูุงู ุชููู ูุดุชุฑ: **+12-15%**
- โ ุงูุฒุงุด ูุฑุฎ ุจุงุฒุฏุฏ ุงุฒ ูุญุตููุงุช: **+20-25%**

๐ฌ **ุฌูุนโุจูุฏ:**
ุจุฑุง ุฏุฑุงูุช ุชุญูู ุฌุงูุน ู ุชุฎุตุต ุจุง ุฌุฒุฆุงุช ฺฉุงููุ ุงุณุชูุงุฏู ุงุฒ **ุชุญูู ูพุดุฑูุชู ฺุฏูุงูู** ุชูุตู ูโุดูุฏ.
"""
        },
        
        'supermarket': {
            'name': 'ุณููพุฑูุงุฑฺฉุช',
            'template': """
๐น **ุงุทูุงุนุงุช ูพุงู:**
- ูุงู ูุฑูุดฺฏุงู: {store_name}
- ููุน ูุฑูุดฺฏุงู: {store_type_fa}
- ูุชุฑุงฺ: {store_size} ูุชุฑ ูุฑุจุน
- ูฺฉุงู: {location}
- ุชุงุฑุฎ ุชุญูู: {analysis_date}

๐ **ุฎูุงุตู ูุฏุฑุช:**
ุชุญูู ุงููู ุณููพุฑูุงุฑฺฉุช {store_name} ูุดุงู ูโุฏูุฏ ฺฉู ฺุฏูุงู ููุณูโูุง ู ูุณุฑ ุญุฑฺฉุช ูุดุชุฑุงู ูุงุฒ ุจู ุจูููโุณุงุฒ ุฏุงุฑุฏ. ุจุง ุงุตูุงุญุงุช ูพุดููุงุฏุ ูพุชุงูุณู ุงูุฒุงุด ูุฑูุด **12-18%** ูุฌูุฏ ุฏุงุฑุฏ.

**ุงูุชุงุฒ ฺฉู ุจูุฑูโูุฑ ฺุฏูุงู:** โญ {score} ุงุฒ 100

๐ **ุชุญูู ูู ฺุฏูุงู:**

| ุดุงุฎุต | ูุถุนุช ูุนู | ูุงูฺฏู ุตูุนุช | ุชูุตู |
|------|------------|--------------|-------|
| ฺุฏูุงู ููุณูโูุง | ูุชูุณุท | ุฎูุจ | ุจูููโุณุงุฒ ุงุฑุชูุงุน ู ุฏุณุชุฑุณ |
| ูุณุฑ ุญุฑฺฉุช ูุดุชุฑ | ูุงุจู ูุจูู | ุนุงู | ุงุฌุงุฏ ูุณุฑูุง ุฑุงูููุง |
| ููุฑูพุฑุฏุงุฒ ูุญุตููุงุช | ูุชูุณุท | ุฎูุจ | ุงูุฒุงุด ููุฑ ุฏุฑ ููุณูโูุง ูุญุตููุงุช ุชุงุฒู |
| ููุทูู ุตูุฏูู | ุดููุบ | ูุชูุณุท | ุงูุฒูุฏู ุตูุฏูู ุง ุจูููโุณุงุฒ |

๐ฅ **ุชุญูู ุฑูุชุงุฑ ูุดุชุฑ:**
- ูุดุชุฑุงู ูุนูููุงู ูุณุฑ U ุดฺฉู ุฑุง ุท ูโฺฉููุฏ
- ูุญุตููุงุช ุถุฑูุฑ ุจุงุฏ ุฏุฑ ุงูุชูุง ูุณุฑ ูุฑุงุฑ ฺฏุฑูุฏ
- ููุณูโูุง ุณุทุญ ฺุดู ุจุดุชุฑู ูุฑูุด ุฑุง ุฏุงุฑูุฏ

๐ฐ **ุชุญูู ูุฑูุด:**
- ูุญุตููุงุช ุชุงุฒู ู ูุจูุงุช ูพุฑูุฑูุดโุชุฑู ุฏุณุชู ูุณุชูุฏ
- ูุญุตููุงุช ุฎุดฺฉุจุงุฑ ูุงุฒ ุจู ุฌุงฺฏุงู ุจูุชุฑ ุฏุงุฑูุฏ
- ฺฉุงูุงูุง ููุฑุงู (impulse) ุจุงุฏ ูุฒุฏฺฉ ุตูุฏูู ุจุงุดูุฏ

๐ง **ุชูุตูโูุง ฺฉูุฏ:**
1. ุจูููโุณุงุฒ ฺุฏูุงู ููุณูโูุง ุจุฑ ุงุณุงุณ ูุฑูุด
2. ุงุฌุงุฏ ููุทูู ููุงุด ูุญุตููุงุช ูุตู
3. ุงูุฒุงุด ุฑูุดูุง ุฏุฑ ุจุฎุด ููู ู ุณุจุฒุฌุงุช
4. ุงุณุชูุงุฏู ุงุฒ ุนูุงุฆู ุฑุงูููุง ูุงุถุญ

๐ **ูพุดโุจู ุฑุดุฏ:**
ุจุง ุงุฌุฑุง ูพุดููุงุฏุงุชุ ุงูุชุธุงุฑ ูโุฑูุฏ:
- โ ุงูุฒุงุด ูุฑูุด ูุงูุงูู: **+12-18%**
- โ ุงูุฒุงุด ูุงูฺฏู ุฎุฑุฏ: **+10-15%**
- โ ฺฉุงูุด ุฒูุงู ุตู: **-20%**

๐ฌ **ุฌูุนโุจูุฏ:**
ุจุฑุง ุฏุฑุงูุช ุชุญูู ุฌุงูุน ุดุงูู ููุดู heat map ุชุฑุฏุฏ ูุดุชุฑุงูุ ุชุญูู ุฏูู ูุฑูุด ูุฑ ุฏุณุชู ู ุทุฑุงุญ ฺุฏูุงู ุญุฑููโุงุ ุงุฒ **ุชุญูู ูพุดุฑูุชู ฺุฏูุงูู** ุงุณุชูุงุฏู ฺฉูุฏ.
"""
        },
        
        'default': {
            'name': 'ุนููู',
            'template': """
๐น **ุงุทูุงุนุงุช ูพุงู:**
- ูุงู ูุฑูุดฺฏุงู: {store_name}
- ููุน ูุฑูุดฺฏุงู: {store_type_fa}
- ูุชุฑุงฺ: {store_size} ูุชุฑ ูุฑุจุน
- ูฺฉุงู: {location}
- ุชุงุฑุฎ ุชุญูู: {analysis_date}

๐ **ุฎูุงุตู ูุฏุฑุช:**
ุชุญูู ุงููู ูุฑูุดฺฏุงู {store_name} ุงูุฌุงู ุดุฏ. ุจุฑุง ุจูุจูุฏ ุนููฺฉุฑุฏ ู ุงูุฒุงุด ูุฑูุดุ ุชูุฌู ุจู ฺุฏูุงูุ ููุฑูพุฑุฏุงุฒ ู ุชุฌุฑุจู ูุดุชุฑ ุถุฑูุฑ ุงุณุช.

**ุงูุชุงุฒ ฺฉู ุจูุฑูโูุฑ ฺุฏูุงู:** โญ {score} ุงุฒ 100

๐ **ูฺฉุงุช ฺฉูุฏ:**

| ุฌูุจู | ูุถุนุช | ุชูุตู |
|------|--------|-------|
| ฺุฏูุงู | ูุงุจู ูุจูู | ุจูููโุณุงุฒ ุชูุตู ูโุดูุฏ |
| ููุฑูพุฑุฏุงุฒ | ูุชูุณุท | ุงูุฒุงุด ุฑูุดูุง |
| ุฏุณุชุฑุณ | ุฎูุจ | ุญูุธ ูุถุนุช ูุนู |
| ุชุฌุฑุจู ูุดุชุฑ | ูุงุจู ุจูุจูุฏ | ุชูุฌู ุจู ูุธุฑุงุช ูุดุชุฑุงู |

๐ง **ุชูุตูโูุง ฺฉูุฏ:**
1. ุจุฑุฑุณ ุฏูู ูุณุฑ ุญุฑฺฉุช ูุดุชุฑุงู
2. ุจูููโุณุงุฒ ฺุฏูุงู ูุญุตููุงุช
3. ุจูุจูุฏ ููุฑูพุฑุฏุงุฒ ู ุฏฺฉูุฑุงุณูู
4. ุชูุฌู ุจู ุชุฌุฑุจู ูุดุชุฑ ุฏุฑ ุชูุงู ููุงุท ุชูุงุณ

๐ **ูพุดโุจู:**
ุจุง ุงุฌุฑุง ุจูููโุณุงุฒโูุง ูพุดููุงุฏ:
- โ ุงูุฒุงุด ูุฑูุด: **+10-15%**
- โ ุจูุจูุฏ ุฑุถุงุช ูุดุชุฑ
- โ ฺฉุงูุด ูุฒููโูุง ุนููุงุช

๐ฌ **ุฌูุนโุจูุฏ:**
ุจุฑุง ุฏุฑุงูุช ุชุญูู ุฌุงูุน ู ุชุฎุตุต ุจุง ุฌุฒุฆุงุช ฺฉุงููุ ุฑุงูููุง ฺฏุงูโุจูโฺฏุงู ุงุฌุฑุง ู ูพุดุชุจุงู ูุณุชูุฑุ ุงุฒ **ุชุญูู ูพุดุฑูุชู ฺุฏูุงูู** ุงุณุชูุงุฏู ฺฉูุฏ.
"""
        }
    }
    
    # ุชุฑุฌูู ููุน ูุฑูุดฺฏุงู
    STORE_TYPE_TRANSLATIONS = {
        'clothing_store': 'ูพูุดุงฺฉ',
        'supermarket': 'ุณููพุฑูุงุฑฺฉุช',
        'grocery_store': 'ุฎูุงุฑุจุงุฑูุฑูุด',
        'electronics_store': 'ููุงุฒู ุงูฺฉุชุฑููฺฉ',
        'bookstore': 'ฺฉุชุงุจโูุฑูุด',
        'jewelry_store': 'ุฌูุงูุฑูุฑูุด',
        'pharmacy': 'ุฏุงุฑูุฎุงูู',
        'cosmetics_store': 'ููุงุฒู ุขุฑุงุด',
        'furniture_store': 'ูุจููุงู',
        'hardware_store': 'ููุงุฒู ุณุงุฎุชูุงู',
        'kids_clothing': 'ูพูุดุงฺฉ ฺฉูุฏฺฉ',
        'kids_toys': 'ุงุณุจุงุจโุจุงุฒ',
        'shoe_store': 'ฺฉูุดโูุฑูุด',
        'other': 'ุณุงุฑ'
    }
    
    def generate_preliminary_analysis(self, store_data: Dict[str, Any]) -> str:
        """
        ุชููุฏ ุชุญูู ุงููู ุจุฑ ุงุณุงุณ ุงุทูุงุนุงุช ูุฑูุดฺฏุงู
        
        Args:
            store_data: ุฏฺฉุดูุฑ ุญุงู ุงุทูุงุนุงุช ูุฑูุดฺฏุงู
        
        Returns:
            ูุชู ุชุญูู ุงููู
        """
        try:
            # ุงุณุชุฎุฑุงุฌ ุงุทูุงุนุงุช
            store_name = store_data.get('store_name', 'ูุฑูุดฺฏุงู')
            store_type = store_data.get('store_type', 'other')
            store_size = store_data.get('store_size', 'ูุงูุดุฎุต')
            location = store_data.get('store_location', 'ูุงูุดุฎุต')
            
            # ุงูุชุฎุงุจ ูุงูุจ ููุงุณุจ
            template_config = self.STORE_TYPE_TEMPLATES.get(
                store_type,
                self.STORE_TYPE_TEMPLATES['default']
            )
            
            template = template_config['template']
            
            # ุชุฑุฌูู ููุน ูุฑูุดฺฏุงู
            store_type_fa = self.STORE_TYPE_TRANSLATIONS.get(store_type, 'ุณุงุฑ')
            
            # ูุญุงุณุจู ุงูุชุงุฒ ุงููู (ุจุฑ ุงุณุงุณ ุงุทูุงุนุงุช ููุฌูุฏ)
            score = self._calculate_preliminary_score(store_data)
            
            # ุชุงุฑุฎ ุชุญูู
            analysis_date = datetime.now().strftime('%Y/%m/%d')
            
            # ุฌุงฺฏุฒู ูุชุบุฑูุง
            analysis_text = template.format(
                store_name=store_name,
                store_type_fa=store_type_fa,
                store_size=store_size,
                location=location,
                analysis_date=analysis_date,
                score=score
            )
            
            return analysis_text.strip()
            
        except Exception as e:
            logger.error(f"Error generating preliminary analysis: {e}", exc_info=True)
            return self._get_fallback_analysis(store_data)
    
    def _calculate_preliminary_score(self, store_data: Dict[str, Any]) -> int:
        """ูุญุงุณุจู ุงูุชุงุฒ ุงููู"""
        score = 70  # ุงูุชุงุฒ ูพุงู
        
        # ุงฺฏุฑ ุงุทูุงุนุงุช ุจุดุชุฑ ุฏุงุฑูุ ุงูุชุงุฒ ุฑุง ุชูุธู ูโฺฉูู
        if store_data.get('store_size'):
            score += 5
        
        if store_data.get('store_location'):
            score += 5
        
        if store_data.get('uploaded_files', {}).get('store_images'):
            score += 10
        
        return min(score, 85)  # ุญุฏุงฺฉุซุฑ 85 ุจุฑุง ุชุญูู ุงููู
    
    def _get_fallback_analysis(self, store_data: Dict[str, Any]) -> str:
        """ุชุญูู ุณุงุฏู ุฏุฑ ุตูุฑุช ุฎุทุง"""
        store_name = store_data.get('store_name', 'ูุฑูุดฺฏุงู')
        
        return f"""
# ุชุญูู ุงููู ูุฑูุดฺฏุงู {store_name}

ุชุญูู ุงููู ูุฑูุดฺฏุงู ุดูุง ุจุง ููููุช ุซุจุช ุดุฏ.

ุจุฑุง ุฏุฑุงูุช ุชุญูู ุฌุงูุน ู ุญุฑููโุงุ ูุทูุงู ุงุฒ **ุชุญูู ูพุดุฑูุชู ฺุฏูุงูู** ุงุณุชูุงุฏู ฺฉูุฏ.

ุงู ุชุญูู ุดุงูู:
- โ ุชุญูู ุฏูู ฺุฏูุงู
- โ ุจุฑุฑุณ ููุฑูพุฑุฏุงุฒ
- โ ุชุญูู ุฑูุชุงุฑ ูุดุชุฑ
- โ ูพุดููุงุฏุงุช ูุงุจู ุงุฌุฑุง
- โ ูพุดโุจู ุฑุดุฏ ูุฑูุด

**ุงูุชุงุฒ ฺฉู:** โญ 75 ุงุฒ 100
"""

