"""
Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù„ÛŒØ§Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ú†ÛŒØ¯Ù…Ø§Ù†Ùˆ
Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ AI Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§
"""

import requests
import json
import logging
from typing import Dict, List, Any, Optional
from django.conf import settings
from django.core.cache import cache
import time

logger = logging.getLogger(__name__)

class LiaraAIService:
    """Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù„ÛŒØ§Ø±Ø§"""
    
    def __init__(self):
        # URL ØµØ­ÛŒØ­ API Ù„ÛŒØ§Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø³ØªÙ†Ø¯Ø§Øª
        self.base_url = "https://ai.liara.ir/api/68cb388afcfe30ace3a2a314/v1"
        self.api_key = getattr(settings, 'LIARA_AI_API_KEY', '')
        self.headers = {
            'Authorization': f'Bearer {self.api_key}',
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'User-Agent': 'Chidmano-AI-Client/1.0'
        }
        
        # Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ù„ÛŒØ§Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø³ØªÙ†Ø¯Ø§Øª
        self.models = {
            'analysis': 'openai/gpt-4.1',           # ØªØ­Ù„ÛŒÙ„ Ø§ØµÙ„ÛŒ
            'design': 'openai/gpt-4.1',             # ØªØ­Ù„ÛŒÙ„ Ø·Ø±Ø§Ø­ÛŒ
            'marketing': 'openai/gpt-4.1',          # ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ
            'psychology': 'openai/gpt-4.1',         # Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ù…Ø´ØªØ±ÛŒ
            'optimization': 'openai/gpt-4.1',       # Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ
            'summary': 'openai/gpt-4.1'             # Ø®Ù„Ø§ØµÙ‡â€ŒØ³Ø§Ø²ÛŒ
        }
    
    def _make_request(self, model: str, prompt: str, max_tokens: int = 4000, temperature: float = 0.7) -> Dict:
        """Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ API Ù„ÛŒØ§Ø±Ø§"""
        try:
            payload = {
                "model": model,
                "messages": [
                    {
                        "role": "system",
                        "content": "Ø´Ù…Ø§ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…ØªØ®ØµØµ ØªØ­Ù„ÛŒÙ„ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ùˆ Ù…Ø´Ø§ÙˆØ± Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ø¯Ù†ÛŒØ§ Ù‡Ø³ØªÛŒØ¯. ØªØ®ØµØµ Ø´Ù…Ø§ Ø¯Ø± Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú†ÛŒØ¯Ù…Ø§Ù† ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ Ùˆ Ø§ÙØ²Ø§ÛŒØ´ ÙØ±ÙˆØ´ Ø§Ø³Øª."
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                "max_tokens": max_tokens,
                "temperature": temperature,
                "top_p": 0.9,
                "frequency_penalty": 0.1,
                "presence_penalty": 0.1
            }
            
            response = requests.post(
                f"{self.base_url}/chat/completions",
                headers=self.headers,
                json=payload,
                timeout=45  # Ú©Ø§Ù‡Ø´ timeout Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ø¨ÛŒØ´ØªØ±
            )
            
            if response.status_code == 200:
                return response.json()
            else:
                logger.error(f"Ø®Ø·Ø§ Ø¯Ø± API Ù„ÛŒØ§Ø±Ø§: {response.status_code} - {response.text}")
                return None
                
        except requests.exceptions.Timeout:
            logger.warning(f"Timeout Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù„ÛŒØ§Ø±Ø§ AI - Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨ÛŒØ´ Ø§Ø² 2 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø·ÙˆÙ„ Ú©Ø´ÛŒØ¯")
            return None
        except requests.exceptions.ConnectionError:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù„ÛŒØ§Ø±Ø§ AI - Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª")
            return None
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù„ÛŒØ§Ø±Ø§ AI: {e}")
            return None
    
    def analyze_store_comprehensive(self, store_data: Dict[str, Any], images: List[str] = None) -> Dict[str, Any]:
        """ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú†Ù†Ø¯ÛŒÙ† Ù…Ø¯Ù„ AI Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµØ§ÙˆÛŒØ±"""
        
        store_name = store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')
        store_type = store_data.get('store_type', 'Ø¹Ù…ÙˆÙ…ÛŒ')
        
        logger.info(f"ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ {store_name} Ø¨Ø§ {len(images) if images else 0} ØªØµÙˆÛŒØ±")
        
        # ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ§Ø²ÛŒ Ø¨Ø§ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
        analyses = {}
        
        # 1. ØªØ­Ù„ÛŒÙ„ Ø§ØµÙ„ÛŒ Ø¨Ø§ GPT-4 Turbo (Ø´Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØµØ§ÙˆÛŒØ±)
        main_analysis = self._analyze_main_store(store_data, images)
        if main_analysis:
            analyses['main'] = main_analysis
        
        # 2. ØªØ­Ù„ÛŒÙ„ Ø·Ø±Ø§Ø­ÛŒ Ø¨Ø§ Claude-3 Opus (Ø¨Ø§ ØªÙ…Ø±Ú©Ø² Ø¨Ø± ØªØµØ§ÙˆÛŒØ±)
        design_analysis = self._analyze_store_design(store_data, images)
        if design_analysis:
            analyses['design'] = design_analysis
        
        # 3. ØªØ­Ù„ÛŒÙ„ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Claude-3 Sonnet
        psychology_analysis = self._analyze_customer_psychology(store_data)
        if psychology_analysis:
            analyses['psychology'] = psychology_analysis
        
        # 4. ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ø¨Ø§ GPT-4o
        marketing_analysis = self._analyze_marketing_potential(store_data)
        if marketing_analysis:
            analyses['marketing'] = marketing_analysis
        
        # 5. Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ GPT-4 Turbo
        optimization_analysis = self._analyze_optimization(store_data)
        if optimization_analysis:
            analyses['optimization'] = optimization_analysis
        
        # ØªØ±Ú©ÛŒØ¨ Ùˆ Ø®Ù„Ø§ØµÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù†ØªØ§ÛŒØ¬
        final_analysis = self._combine_analyses(analyses, store_data, images)
        
        return final_analysis
    
    def _analyze_main_store(self, store_data: Dict[str, Any], images: List[str] = None) -> Dict[str, Any]:
        """ØªØ­Ù„ÛŒÙ„ Ø§ØµÙ„ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¨Ø§ GPT-4 Turbo"""
        
        prompt = f"""
        Ø´Ù…Ø§ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…ØªØ®ØµØµ ØªØ­Ù„ÛŒÙ„ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¯Ù†ÛŒØ§ Ù‡Ø³ØªÛŒØ¯. ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ùˆ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ "{store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}" Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.

        **Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…Ù‡Ù…:**
        1. ØªÙ…Ø§Ù… Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø¨Ø§Ø´Ø¯
        2. Ø§Ø² Ù‡ÛŒÚ† Ú©Ù„Ù…Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø¢Ù„Ù…Ø§Ù†ÛŒØŒ Ú†ÛŒÙ†ÛŒ ÛŒØ§ Ø¹Ø¨Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ú©Ù†ÛŒØ¯
        3. ÙÙ‚Ø· Ø§Ø² Ú©Ù„Ù…Ø§Øª Ùˆ Ø§ØµØ·Ù„Ø§Ø­Ø§Øª ÙØ§Ø±Ø³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
        4. ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ ÙÙ‡Ù… Ø¨Ø±Ø§ÛŒ ØµØ§Ø­Ø¨ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¨Ø§Ø´Ø¯
        5. Ø§Ø² Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: Û¶.Û¸ Ø¨Ù‡ Ø¬Ø§ÛŒ 6.8)

        **Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡:**
        - Ù†Ø§Ù…: {store_data.get('store_name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù†ÙˆØ¹: {store_data.get('store_type', 'Ø¹Ù…ÙˆÙ…ÛŒ')}
        - Ø§Ù†Ø¯Ø§Ø²Ù‡: {store_data.get('store_size', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ø´Ù‡Ø±: {store_data.get('city', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù…Ù†Ø·Ù‚Ù‡: {store_data.get('area', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù…Ø´ØªØ±ÛŒØ§Ù† Ø±ÙˆØ²Ø§Ù†Ù‡: {store_data.get('daily_customers', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - ÙØ±ÙˆØ´ Ø±ÙˆØ²Ø§Ù†Ù‡: {store_data.get('daily_sales', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù…Ø­ØµÙˆÙ„Ø§Øª: {store_data.get('products', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ: {store_data.get('color_scheme', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ: {store_data.get('lighting_type', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ú†ÛŒØ¯Ù…Ø§Ù†: {store_data.get('layout_type', 'Ù†Ø§Ù…Ø´Ø®Øµ')}

        **Ù„Ø·ÙØ§Ù‹ ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯:**

        ## ğŸ¯ ØªØ­Ù„ÛŒÙ„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ {store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}

        ### ğŸ“Š Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ (1-100)
        [Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÙ…Ø§Ù… Ø¹ÙˆØ§Ù…Ù„ØŒ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ù‚ÛŒÙ‚ Ø¯Ù‡ÛŒØ¯]

        ### ğŸ’ª Ù†Ù‚Ø§Ø· Ù‚ÙˆØª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ©
        [Ø­Ø¯Ø§Ù‚Ù„ 7 Ù…ÙˆØ±Ø¯ Ø¨Ø§ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚]

        ### âš ï¸ Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ
        [Ø­Ø¯Ø§Ù‚Ù„ 7 Ù…ÙˆØ±Ø¯ Ø¨Ø§ Ø±Ø§Ù‡â€ŒØ­Ù„]

        ### ğŸ¨ ØªØ­Ù„ÛŒÙ„ Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ú†ÛŒØ¯Ù…Ø§Ù†
        **Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ:**
        [ØªØ­Ù„ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚ Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ ÙØ¹Ù„ÛŒ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª]

        **Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ:**
        [ØªØ­Ù„ÛŒÙ„ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ùˆ ØªØ£Ø«ÛŒØ± Ø¨Ø± Ù…Ø´ØªØ±ÛŒ]

        **Ú†ÛŒØ¯Ù…Ø§Ù† Ù…Ø­ØµÙˆÙ„Ø§Øª:**
        [ØªØ­Ù„ÛŒÙ„ Ú†ÛŒØ¯Ù…Ø§Ù† ÙØ¹Ù„ÛŒ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ]

        ### ğŸ§  ØªØ­Ù„ÛŒÙ„ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ù…Ø´ØªØ±ÛŒ
        **Ø±ÙØªØ§Ø± Ù…Ø´ØªØ±ÛŒ:**
        [ØªØ­Ù„ÛŒÙ„ Ø±ÙØªØ§Ø± Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¯Ø± ÙØ±ÙˆØ´Ú¯Ø§Ù‡]

        **ØªØ¬Ø±Ø¨Ù‡ Ø®Ø±ÛŒØ¯:**
        [ØªØ­Ù„ÛŒÙ„ journey Ù…Ø´ØªØ±ÛŒ]

        ### ğŸ“ˆ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø§ÙØ²Ø§ÛŒØ´ ÙØ±ÙˆØ´
        **ØªØ®Ù…ÛŒÙ† Ø§ÙØ²Ø§ÛŒØ´:**
        [Ø¯Ø±ØµØ¯ Ø¯Ù‚ÛŒÙ‚ Ø§ÙØ²Ø§ÛŒØ´ ÙØ±ÙˆØ´ Ø¨Ø§ ØªØ­Ù„ÛŒÙ„]

        **Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ:**
        [5 Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ ÙØ±ÙˆØ´]

        ### ğŸš€ ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ
        **ÙÙˆØ±ÛŒ (1-2 Ù‡ÙØªÙ‡):**
        [Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙÙˆØ±ÛŒ]

        **Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª (1-3 Ù…Ø§Ù‡):**
        [Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª]

        **Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª (3-12 Ù…Ø§Ù‡):**
        [Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª]

        **Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…: ØªÙ…Ø§Ù… ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ùˆ Ù…Ø®ØªØµ Ø§ÛŒÙ† ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¨Ø§Ø´Ø¯!**
        
        **ØªØ£Ú©ÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ:**
        - ÙÙ‚Ø· Ø§Ø² Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
        - Ù‡ÛŒÚ† Ú©Ù„Ù…Ù‡ ØºÛŒØ±ÙØ§Ø±Ø³ÛŒ Ø¯Ø± Ù¾Ø§Ø³Ø® Ù†Ø¨Ø§Ø´Ø¯
        - ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØµØ§Ø­Ø¨ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§ÛŒØ±Ø§Ù†ÛŒ Ù‚Ø§Ø¨Ù„ ÙÙ‡Ù… Ø¨Ø§Ø´Ø¯
        - Ø§Ø² Ø§ØµØ·Ù„Ø§Ø­Ø§Øª ØªØ¬Ø§Ø±ÛŒ ÙØ§Ø±Ø³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
        """
        
        result = self._make_request(self.models['analysis'], prompt, max_tokens=4000)
        if result and 'choices' in result:
            return {
                'type': 'main_analysis',
                'content': result['choices'][0]['message']['content'],
                'model': 'gpt-4-turbo'
            }
        return None
    
    def _analyze_store_design(self, store_data: Dict[str, Any], images: List[str] = None) -> Dict[str, Any]:
        """ØªØ­Ù„ÛŒÙ„ Ø·Ø±Ø§Ø­ÛŒ Ø¨Ø§ Claude-3 Opus"""
        
        prompt = f"""
        Ø´Ù…Ø§ Ù…ØªØ®ØµØµ Ø·Ø±Ø§Ø­ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ùˆ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ù‡Ø³ØªÛŒØ¯. ØªØ­Ù„ÛŒÙ„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ "{store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}" Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.

        **Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø·Ø±Ø§Ø­ÛŒ:**
        - Ù†ÙˆØ¹ ÙØ±ÙˆØ´Ú¯Ø§Ù‡: {store_data.get('store_type', 'Ø¹Ù…ÙˆÙ…ÛŒ')}
        - Ø§Ù†Ø¯Ø§Ø²Ù‡: {store_data.get('store_size', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ú†ÛŒØ¯Ù…Ø§Ù†: {store_data.get('layout_type', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ: {store_data.get('lighting_type', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ: {store_data.get('color_scheme', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù…Ø­ØµÙˆÙ„Ø§Øª: {store_data.get('products', 'Ù†Ø§Ù…Ø´Ø®Øµ')}

        **ØªØ­Ù„ÛŒÙ„ Ø·Ø±Ø§Ø­ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ:**

        ## ğŸ¨ ØªØ­Ù„ÛŒÙ„ Ø·Ø±Ø§Ø­ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ {store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}

        ### ğŸ—ï¸ ØªØ­Ù„ÛŒÙ„ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø¯Ø§Ø®Ù„ÛŒ
        **ÙØ¶Ø§ Ùˆ Ø¬Ø±ÛŒØ§Ù†:**
        [ØªØ­Ù„ÛŒÙ„ Ø¬Ø±ÛŒØ§Ù† Ù…Ø´ØªØ±ÛŒ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ¶Ø§]

        **Ù†Ù‚Ø§Ø· Ú©Ø§Ù†ÙˆÙ†ÛŒ:**
        [Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ù‚Ø§Ø· Ú©Ø§Ù†ÙˆÙ†ÛŒ]

        ### ğŸ’¡ ØªØ­Ù„ÛŒÙ„ Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ
        **Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ ÙØ¹Ù„ÛŒ:**
        [ØªØ­Ù„ÛŒÙ„ Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ Ù…ÙˆØ¬ÙˆØ¯]

        **Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØ±:**
        [Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ]

        ### ğŸ¨ ØªØ­Ù„ÛŒÙ„ Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ
        **Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ø±Ù†Ú¯:**
        [ØªØ­Ù„ÛŒÙ„ ØªØ£Ø«ÛŒØ± Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø¨Ø± Ù…Ø´ØªØ±ÛŒ]

        **Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ Ø¨Ù‡ÛŒÙ†Ù‡:**
        [Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ]

        ### ğŸ“ ØªØ­Ù„ÛŒÙ„ Ú†ÛŒØ¯Ù…Ø§Ù†
        **Ú†ÛŒØ¯Ù…Ø§Ù† Ù…Ø­ØµÙˆÙ„Ø§Øª:**
        [ØªØ­Ù„ÛŒÙ„ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú†ÛŒØ¯Ù…Ø§Ù†]

        **ÙØ§ØµÙ„Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ:**
        [ØªØ­Ù„ÛŒÙ„ ÙØ§ØµÙ„Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ùˆ ØªØ±Ø§Ú©Ù…]

        ### ğŸ¯ ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø·Ø±Ø§Ø­ÛŒ
        **Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§ÛŒ ÙÙˆØ±ÛŒ:**
        [ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ ÙÙˆØ±ÛŒ Ø·Ø±Ø§Ø­ÛŒ]

        **ØªØ­ÙˆÙ„Ø§Øª Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª:**
        [Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª ØªØ­ÙˆÙ„ÛŒ Ø·Ø±Ø§Ø­ÛŒ]

        **Ù†Ú©ØªÙ‡: ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ú©Ø§Ù…Ù„Ø§Ù‹ ØªØ®ØµØµÛŒ Ùˆ Ø¹Ù…Ù„ÛŒ Ø¨Ø§Ø´Ø¯!**
        """
        
        result = self._make_request(self.models['design'], prompt, max_tokens=3000)
        if result and 'choices' in result:
            return {
                'type': 'design_analysis',
                'content': result['choices'][0]['message']['content'],
                'model': 'claude-3-opus'
            }
        return None
    
    def _analyze_customer_psychology(self, store_data: Dict[str, Any]) -> Dict[str, Any]:
        """ØªØ­Ù„ÛŒÙ„ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Claude-3 Sonnet"""
        
        prompt = f"""
        Ø´Ù…Ø§ Ù…ØªØ®ØµØµ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ù…ØµØ±Ùâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ùˆ Ø±ÙØªØ§Ø±Ø´Ù†Ø§Ø³ÛŒ Ù…Ø´ØªØ±ÛŒ Ù‡Ø³ØªÛŒØ¯. ØªØ­Ù„ÛŒÙ„ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ "{store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}" Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.

        **Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡:**
        - Ù†ÙˆØ¹: {store_data.get('store_type', 'Ø¹Ù…ÙˆÙ…ÛŒ')}
        - Ù…Ø´ØªØ±ÛŒØ§Ù† Ø±ÙˆØ²Ø§Ù†Ù‡: {store_data.get('daily_customers', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - ÙØ±ÙˆØ´ Ø±ÙˆØ²Ø§Ù†Ù‡: {store_data.get('daily_sales', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù…Ø­ØµÙˆÙ„Ø§Øª: {store_data.get('products', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù…Ù†Ø·Ù‚Ù‡: {store_data.get('area', 'Ù†Ø§Ù…Ø´Ø®Øµ')}

        **ØªØ­Ù„ÛŒÙ„ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ù…Ø´ØªØ±ÛŒ:**

        ## ğŸ§  ØªØ­Ù„ÛŒÙ„ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ù…Ø´ØªØ±ÛŒ - {store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}

        ### ğŸ‘¥ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø´ØªØ±ÛŒ
        **Ù…Ø´ØªØ±ÛŒØ§Ù† Ù‡Ø¯Ù:**
        [ØªØ­Ù„ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚ Ù…Ø´ØªØ±ÛŒØ§Ù† Ù‡Ø¯Ù]

        **Ø±ÙØªØ§Ø± Ø®Ø±ÛŒØ¯:**
        [ØªØ­Ù„ÛŒÙ„ Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø±ÙØªØ§Ø±ÛŒ]

        ### ğŸ¯ Ø§Ù†Ú¯ÛŒØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯
        **Ø§Ù†Ú¯ÛŒØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ:**
        [Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø§Ù†Ú¯ÛŒØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯]

        **Ø¹ÙˆØ§Ù…Ù„ ØªØ£Ø«ÛŒØ±Ú¯Ø°Ø§Ø±:**
        [ØªØ­Ù„ÛŒÙ„ Ø¹ÙˆØ§Ù…Ù„ Ø±ÙˆØ§Ù†ÛŒ ØªØ£Ø«ÛŒØ±Ú¯Ø°Ø§Ø±]

        ### ğŸ›’ ØªØ¬Ø±Ø¨Ù‡ Ø®Ø±ÛŒØ¯
        **Journey Ù…Ø´ØªØ±ÛŒ:**
        [ØªØ­Ù„ÛŒÙ„ Ù…Ø³ÛŒØ± Ù…Ø´ØªØ±ÛŒ Ø¯Ø± ÙØ±ÙˆØ´Ú¯Ø§Ù‡]

        **Ù†Ù‚Ø§Ø· ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ:**
        [Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ù‚Ø§Ø· Ú©Ù„ÛŒØ¯ÛŒ ØªØµÙ…ÛŒÙ…]

        ### ğŸ’­ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ ÙØ¶Ø§
        **ØªØ£Ø«ÛŒØ± Ù…Ø­ÛŒØ·:**
        [ØªØ­Ù„ÛŒÙ„ ØªØ£Ø«ÛŒØ± Ù…Ø­ÛŒØ· Ø¨Ø± Ø±ÙØªØ§Ø±]

        **Ø§Ø­Ø³Ø§Ø³Ø§Øª Ù…Ø´ØªØ±ÛŒ:**
        [ØªØ­Ù„ÛŒÙ„ Ø§Ø­Ø³Ø§Ø³Ø§Øª Ùˆ ÙˆØ§Ú©Ù†Ø´â€ŒÙ‡Ø§]

        ### ğŸ¨ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ø¨ØµØ±ÛŒ
        **ØªØ£Ø«ÛŒØ± Ø±Ù†Ú¯â€ŒÙ‡Ø§:**
        [ØªØ­Ù„ÛŒÙ„ ØªØ£Ø«ÛŒØ± Ø±ÙˆØ§Ù†ÛŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§]

        **ØªØ£Ø«ÛŒØ± Ù†ÙˆØ±:**
        [ØªØ­Ù„ÛŒÙ„ ØªØ£Ø«ÛŒØ± Ù†ÙˆØ± Ø¨Ø± Ø±ÙˆØ§Ù†]

        ### ğŸš€ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ
        **ØªÚ©Ù†ÛŒÚ©â€ŒÙ‡Ø§ÛŒ ÙØ±ÙˆØ´:**
        [ØªÚ©Ù†ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ ÙØ±ÙˆØ´]

        **Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ¬Ø±Ø¨Ù‡:**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ]

        **Ù†Ú©ØªÙ‡: ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ØµÙˆÙ„ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ø¨Ø§Ø´Ø¯!**
        """
        
        result = self._make_request(self.models['psychology'], prompt, max_tokens=3000)
        if result and 'choices' in result:
            return {
                'type': 'psychology_analysis',
                'content': result['choices'][0]['message']['content'],
                'model': 'claude-3-sonnet'
            }
        return None
    
    def _analyze_marketing_potential(self, store_data: Dict[str, Any]) -> Dict[str, Any]:
        """ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ø¨Ø§ GPT-4o"""
        
        prompt = f"""
        Ø´Ù…Ø§ Ù…ØªØ®ØµØµ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ùˆ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ù‡Ø³ØªÛŒØ¯. ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ "{store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}" Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.

        **Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±:**
        - Ù†Ø§Ù…: {store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}
        - Ù†ÙˆØ¹: {store_data.get('store_type', 'Ø¹Ù…ÙˆÙ…ÛŒ')}
        - Ù…Ù†Ø·Ù‚Ù‡: {store_data.get('area', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù…Ø´ØªØ±ÛŒØ§Ù† Ø±ÙˆØ²Ø§Ù†Ù‡: {store_data.get('daily_customers', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - ÙØ±ÙˆØ´ Ø±ÙˆØ²Ø§Ù†Ù‡: {store_data.get('daily_sales', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù…Ø­ØµÙˆÙ„Ø§Øª: {store_data.get('products', 'Ù†Ø§Ù…Ø´Ø®Øµ')}

        **ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ:**

        ## ğŸ“ˆ ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ - {store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}

        ### ğŸ¯ ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±
        **Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ù‚Ø§Ø¨ØªÛŒ:**
        [ØªØ­Ù„ÛŒÙ„ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø± Ø¨Ø§Ø²Ø§Ø±]

        **ÙØ±ØµØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø±:**
        [Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ ÙØ±ØµØªâ€ŒÙ‡Ø§ÛŒ Ø±Ø´Ø¯]

        ### ğŸ‘¥ ØªØ­Ù„ÛŒÙ„ Ù…Ø´ØªØ±ÛŒ
        **Ø¨Ø§Ø²Ø§Ø± Ù‡Ø¯Ù:**
        [ØªØ­Ù„ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø§Ø²Ø§Ø± Ù‡Ø¯Ù]

        **Ù†ÛŒØ§Ø²Ù‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ:**
        [Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†ÛŒØ§Ø²Ù‡Ø§ÛŒ Ù¾Ù†Ù‡Ø§Ù†]

        ### ğŸ’° ØªØ­Ù„ÛŒÙ„ Ø¯Ø±Ø¢Ù…Ø¯
        **Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¯Ø±Ø¢Ù…Ø¯:**
        [ØªØ­Ù„ÛŒÙ„ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø§ÙØ²Ø§ÛŒØ´ Ø¯Ø±Ø¢Ù…Ø¯]

        **Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù Ø¯Ø±Ø¢Ù…Ø¯:**
        [Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù]

        ### ğŸš€ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ
        **Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„:**
        [Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„]

        **Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ù…Ø­Ù„ÛŒ:**
        [Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ]

        **Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ ØªØ¬Ø±Ø¨ÛŒ:**
        [Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ¬Ø±Ø¨ÛŒ]

        ### ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ø±Ù‚Ø§Ø¨ØªÛŒ
        **Ù…Ø²ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±Ù‚Ø§Ø¨ØªÛŒ:**
        [Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù…Ø²ÛŒØªâ€ŒÙ‡Ø§]

        **ØªÙ‡Ø¯ÛŒØ¯Ø§Øª:**
        [ØªØ­Ù„ÛŒÙ„ ØªÙ‡Ø¯ÛŒØ¯Ø§Øª]

        ### ğŸ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ
        **Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙÙˆØ±ÛŒ:**
        [Ø§Ù‚Ø¯Ø§Ù…Ø§Øª 30 Ø±ÙˆØ²Ù‡]

        **Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª:**
        [Ø§Ù‚Ø¯Ø§Ù…Ø§Øª 6 Ù…Ø§Ù‡Ù‡]

        **Ù†Ú©ØªÙ‡: ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø¹Ù…Ù„ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø§Ø´Ø¯!**
        """
        
        result = self._make_request(self.models['marketing'], prompt, max_tokens=3000)
        if result and 'choices' in result:
            return {
                'type': 'marketing_analysis',
                'content': result['choices'][0]['message']['content'],
                'model': 'gpt-4o'
            }
        return None
    
    def _analyze_optimization(self, store_data: Dict[str, Any]) -> Dict[str, Any]:
        """ØªØ­Ù„ÛŒÙ„ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ GPT-4 Turbo"""
        
        prompt = f"""
        Ø´Ù…Ø§ Ù…ØªØ®ØµØµ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ùˆ Ø§ÙØ²Ø§ÛŒØ´ Ú©Ø§Ø±Ø§ÛŒÛŒ Ù‡Ø³ØªÛŒØ¯. ØªØ­Ù„ÛŒÙ„ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ "{store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}" Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.

        **Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡:**
        - Ù†Ø§Ù…: {store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}
        - Ù†ÙˆØ¹: {store_data.get('store_type', 'Ø¹Ù…ÙˆÙ…ÛŒ')}
        - Ø§Ù†Ø¯Ø§Ø²Ù‡: {store_data.get('store_size', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ù…Ø´ØªØ±ÛŒØ§Ù† Ø±ÙˆØ²Ø§Ù†Ù‡: {store_data.get('daily_customers', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - ÙØ±ÙˆØ´ Ø±ÙˆØ²Ø§Ù†Ù‡: {store_data.get('daily_sales', 'Ù†Ø§Ù…Ø´Ø®Øµ')}
        - Ú†ÛŒØ¯Ù…Ø§Ù†: {store_data.get('layout_type', 'Ù†Ø§Ù…Ø´Ø®Øµ')}

        **ØªØ­Ù„ÛŒÙ„ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ:**

        ## âš¡ ØªØ­Ù„ÛŒÙ„ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ - {store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}

        ### ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ø±Ø§ÛŒÛŒ
        **Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„:**
        [ØªØ­Ù„ÛŒÙ„ Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ù…Ø´ØªØ±ÛŒ]

        **Ú©Ø§Ø±Ø§ÛŒÛŒ ÙØ¶Ø§:**
        [ØªØ­Ù„ÛŒÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙØ¶Ø§]

        ### ğŸ¯ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú†ÛŒØ¯Ù…Ø§Ù†
        **Ú†ÛŒØ¯Ù…Ø§Ù† Ù…Ø­ØµÙˆÙ„Ø§Øª:**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú†ÛŒØ¯Ù…Ø§Ù†]

        **Ø¬Ø±ÛŒØ§Ù† Ù…Ø´ØªØ±ÛŒ:**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø±ÛŒØ§Ù†]

        ### ğŸ’¡ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØ±
        **Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ:**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØ±]

        **ØµØ±ÙÙ‡â€ŒØ¬ÙˆÛŒÛŒ Ø§Ù†Ø±Ú˜ÛŒ:**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ØµØ±Ù]

        ### ğŸ¨ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨ØµØ±ÛŒ
        **Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ:**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§]

        **Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„Ø§Øª:**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ù…Ø§ÛŒØ´]

        ### ğŸ“ˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ±ÙˆØ´
        **Ù†Ù‚Ø§Ø· ÙØ±ÙˆØ´:**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ù‚Ø§Ø· ÙØ±ÙˆØ´]

        **ØªÚ©Ù†ÛŒÚ©â€ŒÙ‡Ø§ÛŒ ÙØ±ÙˆØ´:**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªÚ©Ù†ÛŒÚ©â€ŒÙ‡Ø§]

        ### ğŸš€ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ
        **Ù…Ø±Ø­Ù„Ù‡ 1 (ÙÙˆØ±ÛŒ):**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ ÙÙˆØ±ÛŒ]

        **Ù…Ø±Ø­Ù„Ù‡ 2 (Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª):**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª]

        **Ù…Ø±Ø­Ù„Ù‡ 3 (Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª):**
        [Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª]

        ### ğŸ“Š Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯
        **KPI Ù‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ:**
        [ØªØ¹Ø±ÛŒÙ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯]

        **Ù†Ø­ÙˆÙ‡ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ:**
        [Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ]

        **Ù†Ú©ØªÙ‡: ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ù‚Ø§Ø¨Ù„ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¹Ù…Ù„ÛŒ Ø¨Ø§Ø´Ø¯!**
        """
        
        result = self._make_request(self.models['optimization'], prompt, max_tokens=3000)
        if result and 'choices' in result:
            return {
                'type': 'optimization_analysis',
                'content': result['choices'][0]['message']['content'],
                'model': 'gpt-4-turbo'
            }
        return None
    
    def _combine_analyses(self, analyses: Dict[str, Any], store_data: Dict[str, Any], images: List[str] = None) -> Dict[str, Any]:
        """ØªØ±Ú©ÛŒØ¨ Ùˆ Ø®Ù„Ø§ØµÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§"""
        
        if not analyses:
            return self._get_fallback_analysis(store_data)
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø®Ù„Ø§ØµÙ‡ Ù†Ù‡Ø§ÛŒÛŒ
        summary_prompt = f"""
        Ø´Ù…Ø§ Ù…ØªØ®ØµØµ Ø®Ù„Ø§ØµÙ‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ ØªØ±Ú©ÛŒØ¨ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ Ù‡Ø³ØªÛŒØ¯. ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ "{store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}" ØªØ±Ú©ÛŒØ¨ Ùˆ Ø®Ù„Ø§ØµÙ‡ Ú©Ù†ÛŒØ¯:

        {json.dumps(analyses, ensure_ascii=False, indent=2)}

        **Ù„Ø·ÙØ§Ù‹ Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯:**

        ## ğŸ¯ Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ ØªØ­Ù„ÛŒÙ„ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ {store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}

        ### ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§ÛŒÛŒ
        [Ø®Ù„Ø§ØµÙ‡ 3-4 Ø®Ø·ÛŒ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ]

        ### ğŸ¯ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ
        [Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ 1-100]

        ### ğŸ’ª Ù†Ù‚Ø§Ø· Ù‚ÙˆØª Ú©Ù„ÛŒØ¯ÛŒ
        [5 Ù†Ù‚Ø·Ù‡ Ù‚ÙˆØª Ø§ØµÙ„ÛŒ]

        ### âš ï¸ Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù…
        [5 Ú†Ø§Ù„Ø´ Ø§ØµÙ„ÛŒ]

        ### ğŸš€ ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¯Ø§Ø±
        [5 ØªÙˆØµÛŒÙ‡ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¯Ø§Ø±]

        ### ğŸ“ˆ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø§ÙØ²Ø§ÛŒØ´ ÙØ±ÙˆØ´
        [Ø¯Ø±ØµØ¯ Ùˆ ØªÙˆØ¶ÛŒØ­]

        ### ğŸ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ
        **ÙÙˆØ±ÛŒ (1-2 Ù‡ÙØªÙ‡):**
        [Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙÙˆØ±ÛŒ]

        **Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª (1-3 Ù…Ø§Ù‡):**
        [Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª]

        **Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª (3-12 Ù…Ø§Ù‡):**
        [Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª]

        **Ù†Ú©ØªÙ‡: Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ÛŒØ¯ Ø¬Ø§Ù…Ø¹ØŒ Ø¹Ù…Ù„ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø§Ø´Ø¯!**
        """
        
        result = self._make_request(self.models['summary'], summary_prompt, max_tokens=2000)
        if result and 'choices' in result:
            return {
                'final_report': result['choices'][0]['message']['content'],
                'detailed_analyses': analyses,
                'store_info': store_data,
                'analysis_timestamp': time.time(),
                'ai_models_used': list(set([analysis.get('model', 'unknown') for analysis in analyses.values() if analysis]))
            }
        
        return self._get_fallback_analysis(store_data)
    
    def _get_fallback_analysis(self, store_data: Dict[str, Any]) -> Dict[str, Any]:
        """ØªØ­Ù„ÛŒÙ„ fallback Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§"""
        return {
            'final_report': f"ØªØ­Ù„ÛŒÙ„ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ {store_data.get('store_name', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')} Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.",
            'detailed_analyses': {},
            'store_info': store_data,
            'analysis_timestamp': time.time(),
            'ai_models_used': ['fallback'],
            'error': 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆÛŒØ³ AI'
        }
    
    def get_ai_insights(self, store_data: Dict[str, Any]) -> Dict[str, Any]:
        """Ø¯Ø±ÛŒØ§ÙØª Ø¨ÛŒÙ†Ø´â€ŒÙ‡Ø§ÛŒ AI Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡"""
        
        # Ø¨Ø±Ø±Ø³ÛŒ cache
        cache_key = f"ai_analysis_{hash(str(store_data))}"
        cached_result = cache.get(cache_key)
        if cached_result:
            return cached_result
        
        # Ø§Ù†Ø¬Ø§Ù… ØªØ­Ù„ÛŒÙ„
        result = self.analyze_store_comprehensive(store_data)
        
        # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± cache (1 Ø³Ø§Ø¹Øª)
        cache.set(cache_key, result, 3600)
        
        return result
